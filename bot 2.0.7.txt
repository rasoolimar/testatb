<?php
/**
 * ================================================================
 * ATB Club Bot โ ุฑุงูููุง ฺฉู (ูุณุฎู 2.0.7)
 * ================================================================
 * ุงู ูุณุฎู ุจุง ุจุงุฒุทุฑุงุญ ูพูู ูุฏุฑุช ุฏูุฑูโูุงุ ุงุตูุงุญ ุณุงุฎุชุงุฑ ุฏุชุงุจุณุ
 * ู ุฑูุน ุจุงฺฏโูุง ฺฉูุฏุ ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ ุฑุง ุจุฑุง ุงุฏูู ู ฺฉุงุฑุจุฑุงู ูุฑุงูู ูโฺฉูุฏ.
 *
 * ูุงุจูุชโูุง ุงุตู:
 * - ุซุจุชโูุงู ุงุฌุจุงุฑ (ูุงูุ ุดูุงุฑูุ ุณุทุญ AIุ ุดุบู) ุฏุฑ ุงุจุชุฏุง ฺฉุงุฑ.
 * - ุงุณุชูุงุฏู ุงุฒ ฺฉ ูุงู ุฏุชุงุจุณ ูุงุญุฏ ู ุญุฐู ูุฑุขูุฏูุง ููุงุฌุฑุช.
 * - ุจุฎุด ยซุขููุฒุด ููุฏูุงุชยป (ุฏูุฑู ุฑุงฺฏุงู ณ ูุฏู) ุจุง ูุงุจูุช ูุฏุฑุช ฺฉุงูู ุงุฒ ูพูู ุงุฏูู.
 * - ุณุณุชู ยซุงุดุชุฑุงฺฉ VIPยป ุจุง ูพุฑุฏุงุฎุช ู ุชุงุฏ ุงุฏูู.
 * - ุณุณุชู ยซฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑยป ุจุง ููฺฉ ุฏุนูุช ุงุฎุชุตุงุต.
 * - ูพูู ูุฏุฑุช ูพุดุฑูุชู ุจุง ูุงุจูุช ูุฑุงุดุ ุญุฐู ู ุงูุฒูุฏู ุฏูุฑูโูุง ู ูุฑุงุญู ุขูโูุง.
 * - ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู ุจุง ูุงุจูุช ููุชุฑ ุฒูุงู (ุงูุฑูุฒุ ููุชู ุงุฎุฑุ ููู).
 * - ุงุฑุณุงู ูพุงู ุงุฏุขูุฑ ุฎูุฏฺฉุงุฑ ุจู ฺฉุงุฑุจุฑุงู ุฌุฏุฏ ูพุณ ุงุฒ ฒด ุณุงุนุช.
 *
 * โจ ูฺฉุงุช ุชุงุฒู ุงู ูุณุฎู (2.0.7) - ุงุตูุงุญุงุช ุณูุงุฑุด:
 * 1) **ุฏุชุงุจุณ ูุงุญุฏ:** ุฑุจุงุช ุจุฑุง ุฎูุงูุฏู ู ููุดุชู ุงุทูุงุนุงุช ููุท ุงุฒ ูุงู `atb_db.json.migrated` ุงุณุชูุงุฏู ูโฺฉูุฏ.
 * 2) **ุจุงุฒุทุฑุงุญ ูุฏุฑุช ุฏูุฑูโูุง:** ุงุฏููโูุง ุงฺฉููู ูโุชูุงููุฏ ุฏูุฑูโูุง ุฑุง ุจู ุทูุฑ ฺฉุงูู (ุนููุงูุ ููุชุ ูุฑุงุญู) ุงุฒ ุทุฑู ูพูู ูุฏุฑุช ูุฑุงุด ฺฉููุฏ.
 * 3) **ุงูุฒูุฏู ุฏูุฑู ูพูู ุฌุฏุฏ:** ุฏูุฑู ยซฺฉุณุจ ู ฺฉุงุฑ ุจุฏูู ุณุฑูุงู ุจุง Aiยป ุจุง ููุช ดนฐ ูุฒุงุฑ ุชููุงู ุจู ุตูุฑุช ูพุดโูุฑุถ ุงุถุงูู ุดุฏ.
 * 4) **ุจูุจูุฏ ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู:** ูุงุจูุช ููุชุฑ ุฒูุงู ุจู ุจุฎุด ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู ุงุถุงูู ุดุฏ.
 * 5) **ุงุตูุงุญ UI:** ุฏฺฉููโูุง ููู ุงุตู ุจุฑุง ุชุงฺฉุฏ ุจุดุชุฑ ู ุฎูุงูุง ุจูุชุฑ ุจุงุฒฺู ุดุฏูุฏ ู ูุงูโูุง ุงุตูุงุญ ฺฏุฑุฏุฏ.
 * 6) **ุฑูุน ุจุงฺฏ ุฎุฑุฏ VIP:** ูุดฺฉู ุชุฏุงุฎู ูุถุนุช ุงุฏูู ุจุง ูุฑุขูุฏ ุฎุฑุฏ ฺฉุงุฑุจุฑ ุจู ุทูุฑ ฺฉุงูู ุญู ุดุฏ.
 * 7) **ุงุฑุชูุง ูุณุฎู:** ูุณุฎู ุฑุจุงุช ุจู 2.0.7 ุจูโุฑูุฒ ุดุฏ.
 *
 * ================================================================
 */

/* ==== CFG START ===================================================
   ููุท ุงู ุจุฎุด ุฑู ุดุฎุตโุณุงุฒ ฺฉู
=================================================================== */
$BOT_TOKEN              = getenv("BOT_TOKEN") ?: "8390747300:AAF0V8Z_Ys3qTuWgKCQHLy4zoxvTxDhYKCg"; // ุชูฺฉู ุฑุจุงุช
$PRIVATE_CHANNEL_INVITE = getenv("PRIVATE_CHANNEL_INVITE") ?: "https://t.me/+hUV4tJ7n3b9kMDlk"; // ููฺฉ ฺฉุงูุงู ุฎุตูุต (ุจุฑุง ุฏูุฑู ุฑุงฺฏุงู)
$PUBLIC_CHANNEL_ID      = "@ATB_Club"; // ุขุฏ ฺฉุงูุงู ุนููู
$SUPPORT_CHAT           = getenv("SUPPORT_CHAT") ?: "-1002827751730"; // ุขุฏ ุณููพุฑฺฏุฑูู ูพุดุชุจุงู (ููู ุจุง -100)

/* VIP: ูพุฑุฏุงุฎุช ู ฺฉุงูุงู ุฎุตูุต (ุจุฑุง ุนุถูุช VIP) */
$VIP_PAYMENT_LINK   = getenv("VIP_PAYMENT_LINK") ?: ""; // ุงฺฏุฑ ููฺฉ ูพุฑุฏุงุฎุช ุขููุงู ุฏุงุฑ ุงูุฌุง ุจฺฏุฐุงุฑ (ุงุฎุชุงุฑ).
$VIP_PRIVATE_INVITE = getenv("VIP_PRIVATE_INVITE") ?: "https://t.me/+hUV4tJ7n3b9kMDlk"; // ููฺฉ ุฏุนูุช ฺฉุงูุงู/ฺฏุฑูู ุฎุตูุต VIP

/* ุงุฏูู ุงุตู ุจุฑ ุงุณุงุณ ุดูุงุฑู */
$ADMIN_PHONE = ["09123079406", "+989150811691"];

/* ุชูุธูุงุช ุณุณุชู ฺฉุณุจ ุฏุฑุขูุฏ */
$REFERRAL_REWARD_AMOUNT = 0.5; // ูุจูุบ ูุฏู ุจู ุฏูุงุฑ ุจุฑุง ูุฑ ุฏุนูุช ูููู
$REFERRAL_REWARD_TEXT   = $REFERRAL_REWARD_AMOUNT . " ุฏูุงุฑ";

$DB_FILE       = __DIR__ . "/atb_db.json.migrated"; // **ููู:** ููุท ุงุฒ ุงู ูุงู ุฏุชุงุจุณ ุงุณุชูุงุฏู ูโุดูุฏ
$LOG_FILE      = __DIR__ . "/atb_log.txt";
$DEBUG         = false; // ุฏุฑ ุตูุฑุช ูุงุฒ true

/* ูุณุฎูโ ุจุงุช ุจุฑุง ููุงุด ุฏุฑ ูพูู/ุฑุงูููุง */
if (!defined('ATB_VERSION')) define('ATB_VERSION', '2.0.7'); // ูุณุฎู ุจูโุฑูุฒ ุดุฏ
/* ==== CFG END ===================================================== */

/* ูุญุฏูุฏุช ุชูุงุดุง ูุฑ ูุฏุฆู (ุซุงูู) */
if (!defined('MIN_WATCH_SECONDS')) define('MIN_WATCH_SECONDS', 480); // 8 ุฏููู

/* ==== BOOT/LOG START ============================================= */
if ($DEBUG) {
  error_reporting(E_ALL);
  ini_set('log_errors', 1);
  ini_set('display_errors', 0);
}
function log_it($msg){
  global $LOG_FILE;
  @file_put_contents($LOG_FILE, date('c')." | ".$msg.PHP_EOL, FILE_APPEND);
}
/* ==== BOOT/LOG END =============================================== */

/* ==== DB START ==================================================== */
function get_default_toolkit_buttons() {
    return [
        ["text"=>"๐ฒ Gemini ุจุฑุง Android","type"=>"url", "value"=>"https://play.google.com/store/apps/details?id=com.google.android.apps.bard"],
        ["text"=>"๐ฒ Gemini ุจุฑุง iOS","type"=>"url", "value"=>"https://apps.apple.com/app/gemini-google-ai/id6477494283"],
        ["text"=>"๐ฒ ChatGPT ุจุฑุง iOS","type"=>"url", "value"=>"https://apps.apple.com/app/openai-chatgpt/id6448311069"],
        ["text"=>"๐ฒ ChatGPT ุจุฑุง Android","type"=>"url", "value"=>"https://play.google.com/store/apps/details?id=com.openai.chatgpt"],
        ["text"=>"๐ ูุณุฎู ูุจ ChatGPT","type"=>"url", "value"=>"https://chat.openai.com/"],
        ["text"=>"๐ก๏ธ ุงฺฉุงูุช VPN ฺฉโุณุงูู ExpressVPN","type"=>"callback", "value"=>"toolkit_vpn"],
    ];
}

function get_default_free_course() {
    return [
        "id" => 1,
        "title" => "ุขููุฒุด ููุฏูุงุช ATB",
        "description" => "ฺฉ ุฏูุฑู ุฑุงฺฏุงู ณ ูุฑุญููโุง ุจุฑุง ุดุฑูุน ฺฉุงุฑ ุจุง ููุด ูุตููุน ู ูุฑูุฏ ุจู ฺฉูุงุจ ATB.",
        "price" => 0,
        "content" => [
            [
                "type" => "video",
                "file_id" => "BAACAgIAAxkBAAIVRGY_T6P0zLftVs7LOKL_1S3t_V5hAAK2PwACjEApSlT6lQ1-yALvNQQ",
                "caption" => "๐ฌ <b>ูุฏุฆู ฑ ุงุฒ ณ: ฺุฑุง ุงูุงู ุจุงุฏ ุจุง AI ุงุฒ ุจูู ุฌูู ุจุฒูุ</b>\n\n"
                            . "<b>ูฺฉุชู ููู:</b> ุจุฑุง ุฏุฏู ูุฑ ูุฏุฆู ููุท <b>ดธ ุณุงุนุช</b> ููุช ุฏุงุฑุ ูฺฏุฑูู ุฏุณุชุฑุณโุงุช ุจู ุฑุจุงุช ุชุง <b>ณ ุฑูุฒ</b> ูุญุฏูุฏ ูโุดูุฏ.\n\n"
                            . "<b>ุชูุฑู ุงูู:</b> ูุณุช <b>ุณู ูุฏู ููู ุงู ููุชูโุงุช</b> ุฑุง ุจููุณ. ูุฑฺู ุฏููโุชุฑุ ุจูุชุฑ! (ูุซูุงู: ุณุงุฎุช ณ ูพุณุช ุงูุณุชุงฺฏุฑุงูุ ุขูุงุฏูโฺฉุฑุฏู ูพุงุณุฎโูุง ุฎูุฏฺฉุงุฑ ูุงุชุณุงูพ ู...)\n\n"
                            . "ุจุง ุชูุงู ฺฉุฑุฏู ุงู ุฏูุฑูุ ุนุถูุชุช ุฏุฑ ฺฉุงูุงู ุฎุตูุต ATB <b>ุฑุงฺฏุงู</b> ูโุดูุฏ.\n\n"
                            . "ุญุงูุง ูุฏุฆู ุฑุง ุจุจู ู ุจุนุฏ ุฏฺฉูู ุฒุฑ ุฑุง ุจุฒู ุชุง ุชูุฑูุช ุฑุง ุจูุฑุณุช.",
                "exercise_prompt" => "ุจุณุงุฑ ุฎุจ! ุญุงูุง <b>ุณู ูุฏู ูุดุฎุต ุงู ููุชูโุงุช</b> ุฑุง ุงูุฌุง ุจููุณ ู ุจูุฑุณุช."
            ],
            [
                "type" => "video",
                "file_id" => "BAACAgIAAxkBAAIVR2Y_T6Sstb8eJcCeG5B2sW3EVbXPAAK3PwACjEApSn3N5P1H-K1JNQQ",
                "caption" => "๐ฌ <b>ูุฏุฆู ฒ ุงุฒ ณ: ูุตุจ ู ุดุฑูุน ฺฉุงุฑ ุจุง ChatGPT</b>\n\n"
                            . "<b>ุงุฏุขูุฑ:</b> ดธ ุณุงุนุช ุจุฑุง ูุฑ ูุฏุฆู ูุฑุตุช ุฏุงุฑุ ูฺฏุฑูู ณ ุฑูุฒ ูุญุฏูุฏ ูโุดู.\n\n"
                            . "<b>ุชูุฑู ุฏูู:</b> ChatGPT ุฑุง ูุตุจ ฺฉูุ <b>ููุงู ุณู ูุฏู ฺฉู ูุฑุญูู ูุจู ููุดุช</b> ุฑุง ุงุฒุด ุจูพุฑุณ ู ุงุฒ ุฌูุงุจ ฺฉู ุจูุช ูโุฏูุฏ ฺฉ <b>ุงุณฺฉุฑูโุดุงุช</b> ุจฺฏุฑ ู ุงูุฌุง ุจูุฑุณุช.",
                "exercise_prompt" => "ุนุงูู! ุญุงูุง ูุทูุงู <b>ุงุณฺฉุฑูโุดุงุช ฺฏูุชฺฏูุช ุจุง ChatGPT</b> ุฑุง ุงูุฌุง ุจูุฑุณุช."
            ],
            [
                "type" => "video",
                "file_id" => "BAACAgIAAxkBAAIVSWY_T6XzC0VwU8x_vHl8AAGi-XW3OQACtT8AAoxAKUqYyT49f2sD5zUE",
                "caption" => "๐ฌ <b>ูุฏุฆู ณ ุงุฒ ณ: ุชููุฏ ูุญุชูุง ูููู ุจุง ูุฏู CTFC</b>\n\n"
                            . "<b>ุขุฎุฑู ุงุฏุขูุฑ:</b> ููุท ดธ ุณุงุนุช ูุฑุตุช ุฏุงุฑ!\n\n"
                            . "<b>ุชูุฑู ุณูู:</b> ุจุง ุงุณุชูุงุฏู ุงุฒ <b>ูพุฑุงููพุช CTFC</b> ฺฉู ุฏุฑ ูุฏุฆู ุงุฏ ฺฏุฑูุชุ ฺฉ ุณูุงุฑู ูุญุชูุง ุจุฑุง ฺฉุณุจโูฺฉุงุฑุช ุจุณุงุฒ (ุนููุงูุ ููุงุจุ ุจุฏูู ู ูพุงุงู) ู <b>ูุชุฌู ููุง</b> ุฑุง ุจู ุตูุฑุช ูุชู ุง ุงุณฺฉุฑูโุดุงุช ุจุฑุง ูุง ุจูุฑุณุช.",
                "exercise_prompt" => "ููุจุช ุจู ุฌุงุฏู CTFC ุฑุณุฏ! <b>ุฎุฑูุฌ ูพุฑุงููพุช ุฎูุฏ ุฑุง</b> ุงูุฌุง ุจูุฑุณุช."
            ]
        ]
    ];
}

function get_default_paid_course() {
    return [
        "id" => 2,
        "title" => "ฺฉุณุจ ู ฺฉุงุฑ ุจุฏูู ุณุฑูุงู ุจุง Ai",
        "description" => "ุขุง ููุดู ุฑูุง ุฑุงูโุงูุฏุงุฒ ฺฉุณุจโูฺฉุงุฑ ุฎูุฏุชุงู ุฑุง ุฏุงุดุชูโุงุฏ ุงูุง ุณุฑูุงู ุงููู ูุงูุน ุดูุง ุจูุฏูุ ุงู ุฏูุฑู ูุณุฑ ุดูุง ุฑุง ุจุฑุง ุณุงุฎุช ฺฉ ุจุฒูุณ ุขููุงู ุณูุฏุขูุฑุ ุจุฏูู ูุงุฒ ุจู ุญุช ฺฉ ุฑุงู ุณุฑูุงูุ ูููุงุฑ ูโฺฉูุฏ. ูุง ุจู ุดูุง ุงุฏ ูโุฏูู ฺุทูุฑ ุจุง ูุฏุฑุช ููุด ูุตููุนุ ูุญุตูู ูพุฏุง ฺฉูุฏุ ูุญุชูุง ุญุฑููโุง ุจุณุงุฒุฏ ู ุจู ุฏุฑุขูุฏ ุจุฑุณุฏ.\n\n"
                     . "<b>ฺู ฺุฒูุง ุฏุฑ ุงู ุฏูุฑู ุงุฏ ูโฺฏุฑุฏุ</b>\n"
                     . "โซ๏ธ <b>ูุตู ุงูู: ูพุฏุง ฺฉุฑุฏู ูุญุตูู ุจุฑูุฏู:</b> ุงุฏฺฏุฑ ุชฺฉูฺฉโูุง ูพุฏุง ฺฉุฑุฏู ูุญุตููุงุช ฺฉู ุชูุงุถุง ุจุงูุง ุฏุงุฑูุฏ ู ูุงุฒ ุจู ุงูุจุงุฑุฏุงุฑ ูุฏุงุฑูุฏ.\n"
                     . "โซ๏ธ <b>ูุตู ุฏูู: ุณุงุฎุช ูุญุชูุง ูุฑูุณ ุจุง AI:</b> ฺฺฏููู ุจุฑุง ูุญุตูู ุฎูุฏ ุณูุงุฑูุ ูุฏู ู ูพุณุชโูุง ุงูุณุชุงฺฏุฑุงู ุฌุฐุงุจ ุจุณุงุฒุฏุ ุญุช ุงฺฏุฑ ูฺ ุชุฌุฑุจูโุง ุฏุฑ ุชููุฏ ูุญุชูุง ูุฏุงุฑุฏ.\n"
                     . "โซ๏ธ <b>ูุตู ุณูู: ูุฑูุด ู ุจุงุฒุงุฑุงุจ ุงุชููุงุชฺฉ:</b> ุงุณุชูุงุฏู ุงุฒ ุงุจุฒุงุฑูุง ููุด ูุตููุน ุจุฑุง ูพุงุณุฎฺฏู ุจู ูุดุชุฑุงู ู ุณุงุฎุช ูู ูุฑูุด.\n"
                     . "โซ๏ธ <b>ูุตู ฺูุงุฑู: ุฑุดุฏ ู ุชูุณุนู:</b> ุงุณุชุฑุงุชฺโูุง ุงูุฒุงุด ูุฑูุด ู ุชุจุฏู ุดุฏู ุจู ฺฉ ุจุฑูุฏ ูุนุชุจุฑ ุฏุฑ ุญูุฒู ฺฉุงุฑ ุฎูุฏ.\n\n"
                     . "๐ <b>ูุฏู ูฺู ุงู ุฏูุฑู:</b> ุจุง ุซุจุชโูุงู ุฏุฑ ุงู ุฏูุฑูุ ุจู ุตูุฑุช ุฑุงฺฏุงู ุจู <b>ฺฉุงูุงู VIP</b> ูุง ุฏุณุชุฑุณ ูพุฏุง ฺฉุฑุฏู ู ฺฉ <b>ุงฺฉุงูุช VPN ฺฉุณุงูู ExpressVPN</b> (ุจู ุงุฑุฒุด ูุฌููุน นทฐ ูุฒุงุฑ ุชููุงู) ูุฏู ูโฺฏุฑุฏ!\n\n"
                     . "ุจุฑุง ุดุฑูุน ุงู ูุณุฑ ูุฌุงูโุงูฺฏุฒุ ุฑู ุฏฺฉูู ุฎุฑุฏ ฺฉูฺฉ ฺฉูุฏุ ุฑุณุฏ ุฑุง ุงุฑุณุงู ฺฉูุฏ ุชุง ุฏุณุชุฑุณ ุดูุง ุชูุณุท ูพุดุชุจุงู ูุนุงู ุดูุฏ.",
        "price" => 490000,
        "content" => [] // ุงุฏูู ุจุงุฏ ูุฑุงุญู ุฑุง ุงุถุงูู ฺฉูุฏ
    ];
}


function get_initial_db_structure() {
    return [
      "users" => [],
      "courses" => [get_default_free_course(), get_default_paid_course()],
      "user_courses" => [],
      "subscriptions" => [], // For VIP
      "pending_exercises" => [],
      "pending_receipts" => [],
      "pending_rejects" => [],
      "pending_support_replies" => [],
      "support_open" => [],
      "admin_ids" => [],
      "pending_broadcast" => null, // Message data for broadcast
      "pending_admin_inputs" => [],
      "vip_card" => ["file_id" => null],
      "await_set_vip_card" => [],
      "start_media" => ["file_id" => null, "type" => null],
      "await_set_start_media" => [],
      "toolkit_buttons" => get_default_toolkit_buttons(),
      "business_automation_requests" => [], // New feature
      "last_reminder_check" => 0
    ];
}


if (!file_exists($DB_FILE)) {
  @file_put_contents($DB_FILE, json_encode(get_initial_db_structure(), JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
}

function db_load(){
  global $DB_FILE;
  $d = json_decode(@file_get_contents($DB_FILE), true) ?: ["users"=>[]];
  $defaults = get_initial_db_structure();
  foreach ($defaults as $key => $value) {
      if (!isset($d[$key])) {
          $d[$key] = $value;
      }
  }
  return $d;
}

function db_save($db){
  global $DB_FILE;
  $tmp = $DB_FILE.".tmp";
  $json = json_encode($db, JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);
  $fp = @fopen($tmp, 'c+');
  if ($fp){
    @flock($fp, LOCK_EX);
    @ftruncate($fp, 0);
    @fwrite($fp, $json);
    @fflush($fp);
    @flock($fp, LOCK_UN);
    @fclose($fp);
    @rename($tmp, $DB_FILE);
  } else {
    @file_put_contents($DB_FILE, $json, LOCK_EX);
  }
}

// ** NEW **: Function to add missing default courses on startup
function add_missing_courses_if_needed(&$db) {
    $defaults = [get_default_free_course(), get_default_paid_course()];
    $existing_ids = array_column($db['courses'], 'id');
    $changed = false;
    foreach ($defaults as $default_course) {
        if (!in_array($default_course['id'], $existing_ids)) {
            $db['courses'][] = $default_course;
            $changed = true;
        }
    }
    if ($changed) {
        db_save($db);
        log_it("DATABASE: Added missing default courses.");
    }
}


function &user(&$db,$id){
  if(!isset($db["users"][$id])){
    $db["users"][$id]=[
      "state"=>"idle",
      "name"=>null,"phone"=>null,"job"=>null,"ai"=>null,
      "created_at"=>time(),
      "watch_started_at"=>0,
      "video_deadlines"=>[], // [courseId_step => timestamp]
      "lock_until"=>0,
      "banned"=>false,
      "referrer_id"=>null,
      "referral_balance_usd"=>0,
      "reminder_sent"=>false,
      "biz_auto_form_data" => []
    ];
  } else {
    // Self-healing for existing users
    if(!isset($db["users"][$id]["created_at"]))         $db["users"][$id]["created_at"]=time();
    if(!isset($db["users"][$id]["watch_started_at"]))   $db["users"][$id]["watch_started_at"]=0;
    if(!isset($db["users"][$id]["video_deadlines"]))    $db["users"][$id]["video_deadlines"]=[];
    if(!isset($db["users"][$id]["lock_until"]))         $db["users"][$id]["lock_until"]=0;
    if(!isset($db["users"][$id]["banned"]))             $db["users"][$id]["banned"]=false;
    if(!isset($db["users"][$id]["referrer_id"]))        $db["users"][$id]["referrer_id"]=null;
    if(!isset($db["users"][$id]["referral_balance_usd"])) $db["users"][$id]["referral_balance_usd"]=0;
    if(isset($db["users"][$id]["referral_balance"])) { // Migration for old referral balance
        unset($db["users"][$id]["referral_balance"]);
    }
    if(!isset($db["users"][$id]["reminder_sent"]))      $db["users"][$id]["reminder_sent"]=false;
    if(!isset($db["users"][$id]["biz_auto_form_data"])) $db["users"][$id]["biz_auto_form_data"]=[];
  }
  return $db["users"][$id];
}

function get_course_by_id($db, $course_id){
    foreach($db['courses'] as $course){
        if($course['id'] == $course_id) return $course;
    }
    return null;
}
function get_user_course_progress(&$db, $user_id, $course_id){
    return $db['user_courses'][$user_id][$course_id] ?? ['status'=>'not_started', 'progress'=> -1];
}

function remove_pending_exercise(&$db, $userId, $courseId, $step){
    $out = [];
    foreach($db["pending_exercises"] as $it){
        if(!($it["user_id"] == $userId && $it["course_id"] == $courseId && $it["step"] == $step)){
            $out[] = $it;
        }
    }
    $db["pending_exercises"] = $out;
}

function support_open_upsert(&$db, $userId, $mid, $last_text=""){
  $found = false; $now=time();
  foreach($db["support_open"] as &$t){
    if($t["user_id"] == $userId){
      $t["time"]=$now;
      $t["last_mid"]=$mid;
      if($last_text!=="") $t["last_text"]=$last_text;
      $found=true;
      break;
    }
  }
  if(!$found){
    $db["support_open"][] = ["user_id"=>$userId,"time"=>time(),"last_mid"=>$mid,"last_text"=>$last_text];
  }
}
function support_open_close_user(&$db, $userId){
  $out=[];
  foreach($db["support_open"] as $t){ if($t["user_id"]!=$userId) $out[]=$t; }
  $db["support_open"]=$out;
}
/* ==== DB END ====================================================== */

/* ==== TG HELPERS START =========================================== */
$API = "https://api.telegram.org/bot".$BOT_TOKEN."/";
function http_post($url, $params){
  if (function_exists('curl_init')) {
    $ch = curl_init($url);
    curl_setopt_array($ch, [
      CURLOPT_RETURNTRANSFER => 1,
      CURLOPT_POST => 1,
      CURLOPT_POSTFIELDS => $params,
      CURLOPT_TIMEOUT => 20
    ]);
    $res = curl_exec($ch);
    if ($res === false) { $res = "CURL_ERR: ".curl_error($ch); }
    curl_close($ch); return $res;
  } else {
    $opts = ['http' => [
      'method'  => 'POST',
      'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
      'content' => http_build_query($params),
      'timeout' => 20
    ]];
    return @file_get_contents($url, false, stream_context_create($opts));
  }
}
function tg_request($method, $params) {
    global $API;
    $res = http_post($API . $method, $params);
    log_it("{$method}: " . $res);
    return json_decode($res, true);
}
function tg_sendMessage($chat,$text,$markup=null){
  $p = ["chat_id"=>$chat,"text"=>$text,"parse_mode"=>"HTML", "disable_web_page_preview"=>true];
  if($markup) $p["reply_markup"]=$markup;
  return tg_request("sendMessage", $p);
}
function tg_editMessageText($chat, $mid, $text, $markup = null) {
    $p = ["chat_id" => $chat, "message_id" => $mid, "text" => $text, "parse_mode" => "HTML", "disable_web_page_preview" => true];
    if ($markup) $p["reply_markup"] = $markup;
    return tg_request("editMessageText", $p);
}
function tg_sendVideo($chat,$src,$cap,$markup=null){
  $p = ["chat_id"=>$chat,"video"=>$src,"caption"=>$cap,"parse_mode"=>"HTML"];
  if($markup) $p["reply_markup"]=$markup;
  return tg_request("sendVideo", $p);
}
function tg_sendAnimation($chat,$src,$cap=null,$markup=null){
    $p = ["chat_id"=>$chat,"animation"=>$src];
    if($cap) $p["caption"] = $cap;
    if($markup) $p["reply_markup"]=$markup;
    return tg_request("sendAnimation", $p);
}
function tg_sendPhoto($chat,$url,$cap,$markup=null){
  $p = ["chat_id"=>$chat,"photo"=>$url,"caption"=>$cap,"parse_mode"=>"HTML"];
  if($markup) $p["reply_markup"]=$markup;
  return tg_request("sendPhoto", $p);
}
function tg_forwardMessage($to,$from,$msgId){
  return tg_request("forwardMessage", ["chat_id"=>$to,"from_chat_id"=>$from,"message_id"=>$msgId]);
}
function tg_copyMessage($to, $from, $msgId, $markup = null) {
    $p = ["chat_id" => $to, "from_chat_id" => $from, "message_id" => $msgId];
    if ($markup) $p["reply_markup"] = $markup;
    return tg_request("copyMessage", $p);
}
function tg_answerCb($id,$text=""){
  return tg_request("answerCallbackQuery", ["callback_query_id"=>$id,"text"=>$text]);
}
function kb($rows){ return json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE); }
function btn($t,$d){ return ["text"=>$t,"callback_data"=>$d]; }
function rkb($rows){ return json_encode(["keyboard"=>$rows,"resize_keyboard"=>true,"one_time_keyboard"=>true], JSON_UNESCAPED_UNICODE); }
function rkb_remove(){ return json_encode(["remove_keyboard" => true], JSON_UNESCAPED_UNICODE); }
function send_lines_in_chunks($chat, $lines, $chunkSize = 50){
    if (empty($lines)) {
        tg_sendMessage($chat, "ูฺ ููุฑุฏ ุจุฑุง ููุงุด ูุฌูุฏ ูุฏุงุฑุฏ.");
        return;
    }
    $buf = []; $count = 0;
    foreach($lines as $ln){
        $buf[] = $ln; $count++;
        if($count % $chunkSize == 0){ tg_sendMessage($chat, implode("\n", $buf)); $buf = []; }
    }
    if(!empty($buf)) tg_sendMessage($chat, implode("\n", $buf));
}
function normalize_phone($raw){
  $p = preg_replace('~\D+~','',$raw);
  if(strpos($p,'+98')===0) $p = '0'.substr($p,3);
  if(strpos($p,'98')===0)  $p = '0'.substr($p,2);
  if($p && $p[0] !== '0')  $p = '0'.$p;
  return $p;
}
function msg_get_video_file_id($m, &$kind=null){
  $kind=null;
  if(isset($m["video"]["file_id"])) { $kind="video"; return $m["video"]["file_id"]; }
  if(isset($m["animation"]["file_id"])) { $kind="animation"; return $m["animation"]["file_id"]; }
  if(isset($m["document"]["file_id"]) && isset($m["document"]["mime_type"]) && strpos($m["document"]["mime_type"],"video/")===0){
    $kind="document"; return $m["document"]["file_id"];
  }
  return null;
}
function msg_get_any_media_file_id($m, &$kind=null) {
    if ($v = msg_get_video_file_id($m, $k)) { $kind = $k; return $v; }
    if ($p = msg_get_photo_file_id($m)) { $kind = "photo"; return $p; }
    return null;
}
function msg_get_photo_file_id($m){
  if(isset($m["photo"]) && is_array($m["photo"]) && count($m["photo"])>0){
    $arr = $m["photo"];
    $last = $arr[count($arr)-1];
    return $last["file_id"] ?? null;
  }
  if(isset($m["document"]["mime_type"]) && strpos($m["document"]["mime_type"],"image/")===0){
    return $m["document"]["file_id"];
  }
  return null;
}
function is_admin(&$db, $userId){
  global $ADMIN_PHONE;
  if(!$userId) return false;
  if(in_array((int)$userId, $db["admin_ids"] ?? [], true)) return true;
  $u = $db["users"][$userId] ?? null;
  if($u){
    $ph = normalize_phone($u["phone"] ?? "");
    if($ph){
      $approved = [];
      if (is_array($ADMIN_PHONE)) {
        foreach($ADMIN_PHONE as $p){ $approved[] = normalize_phone($p); }
      } else {
        $approved[] = normalize_phone($ADMIN_PHONE);
      }
      if (in_array($ph, $approved, true)){
        if(!in_array((int)$userId, $db["admin_ids"], true)) {
          $db["admin_ids"][] = (int)$userId;
          db_save($db);
        }
        return true;
      }
    }
  }
  return false;
}
/* ==== TG HELPERS END ============================================= */

/* ==== REGISTRATION & RESTRICTIONS ================================= */
function is_fully_registered(&$u) {
    return !empty($u["name"]) && !empty($u["phone"]) && !empty($u["ai"]) && !empty($u["job"]);
}

function handle_registration_flow(&$u, $chat, $text) {
    if (empty($u["name"])) {
        $u["state"] = "collect_name";
        tg_sendMessage($chat, "ุณูุงู! ุจู ฺฉูุงุจ ATB ุฎูุด ุขูุฏ.\n\nุจุฑุง ุงูฺฉู ุจูุชุฑ ุจุดูุงุณูุชุ ูุทูุงู <b>ุงุณู ู ูุงูู ุฎูุฏ ุฑุง</b> ุจูุฑุณุช.", rkb_remove());
        return false;
    }
    if (empty($u["phone"])) {
        $u["state"] = "await_phone";
        tg_sendMessage($chat, "ุจุณุงุฑ ุฎุจ! ุญุงูุง ุจุง ุฏฺฉููโ ูพุงู <b>ุดูุงุฑู ููุจุงู ุฎูุฏ ุฑุง</b> ุจุฑุง ูุง ุจูุฑุณุช ุชุง ุจุชูุงูู ุฏุฑ ุงุฑุชุจุงุท ุจุงุดู.", rkb([[["text"=>"๐ฑ ุงุฑุณุงู ุดูุงุฑู ุงุฒ ุทุฑู ุชูฺฏุฑุงู","request_contact"=>true]]]));
        return false;
    }
    if (empty($u["ai"])) {
        $u["state"] = "await_ai";
        tg_sendMessage($chat, "ููููู! ุญุงูุง ุจฺฏู <b>ฺูุฏุฑ ุจุง ููุด ูุตููุน ุขุดูุง ุฏุงุฑุ</b>", kb([
            [btn("ูฺ (ุชุง ุญุงูุง ุงุณุชูุงุฏู ูฺฉุฑุฏูโุงู)","ai_lvl:ุตูุฑ")],[btn("ฺฉู (ููุท ุงุณูุด ุฑุง ุดูุฏูโุงู)","ai_lvl:ฺฉู")],
            [btn("ูุชูุณุท (ฺฏุงู ุจุฑุง ฺฉุงุฑูุงู ุงุณุชูุงุฏู ูโฺฉูู)","ai_lvl:ูุชูุณุท")],[btn("ุญุฑููโุง (ุงุจุฒุงุฑ ุงุตู ฺฉุงุฑู ุดุฏู)","ai_lvl:ุญุฑููโุง")]
        ]));
        return false;
    }
    if (empty($u["job"])) {
        $u["state"] = "collect_job_profile";
        tg_sendMessage($chat, "ุฏฺฏุฑ ฺุฒ ููุงูุฏู! ูุทูุงู <b>ุดุบู ุง ุฒููู ฺฉุงุฑ ุฎูุฏ ุฑุง</b> ูู ุจู ูุง ุจฺฏู.", rkb_remove());
        return false;
    }
    return true;
}

function to_jalali($timestamp, $format = 'Y/m/d') {
    if (!$timestamp) return 'โ';
    // This is a simplified conversion and might have slight inaccuracies. For production, a dedicated library is better.
    $g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    $j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
    $gy = date('Y', $timestamp); $gm = date('m', $timestamp); $gd = date('d', $timestamp);
    $g_day_no = 365*($gy-1) + floor(($gy-1)/4) - floor(($gy-1)/100) + floor(($gy-1)/400);
    for($i=0; $i<$gm-1; ++$i) $g_day_no += $g_days_in_month[$i];
    if($gm>2 && (($gy%4==0 && $gy%100!=0) || ($gy%400==0))) $g_day_no++;
    $g_day_no += $gd;
    $j_day_no = $g_day_no - 226899;
    $jy = 1300;
    while($j_day_no >= 365){
      $is_leap = ($jy%33==1 || $jy%33==5 || $jy%33==9 || $jy%33==13 || $jy%33==17 || $jy%33==22 || $jy%33==26 || $jy%33==30);
      $days_in_year = $is_leap ? 366 : 365;
      if($j_day_no >= $days_in_year){ $j_day_no -= $days_in_year; $jy++; } else { break; }
    }
    $jm = 0; for($i=0; $i<12; $i++){ $jm_days = ($i<6) ? 31 : (($i<11) ? 30 : 29); if($j_day_no >= $jm_days) { $j_day_no -= $jm_days; } else { $jm=$i+1; break; } }
    $jd = $j_day_no + 1;
    $replace_map = [ 'Y' => $jy, 'm' => sprintf('%02d', $jm), 'd' => sprintf('%02d', $jd), 'H' => date('H', $timestamp), 'i' => date('i', $timestamp), 's' => date('s', $timestamp) ];
    return strtr($format, $replace_map);
}
function user_is_locked($u){ return (int)($u["lock_until"]??0) > time(); }
function user_is_banned($u){ return !empty($u["banned"]); }
function maybe_auto_unlock(&$u, $chat){
  $lu = (int)($u["lock_until"]??0);
  if ($lu>0 && $lu <= time()){
    $u["lock_until"]=0;
    tg_sendMessage($chat,"โ ูุญุฏูุฏุช ุดูุง ุจูโุตูุฑุช ุฎูุฏฺฉุงุฑ ุจุฑุฏุงุดุชู ุดุฏ. ุฎูุดุญุงูู ฺฉู ุจุฑฺฏุดุช! ูโุชูุงู ุจู ฺฉุงุฑุช ุงุฏุงูู ุฏู.");
    return true;
  }
  return false;
}
function only_support_kb(){ return kb([[btn("๐ ุชูุงุณ ุจุง ูพุดุชุจุงู","support_contact")]]); }

function maybe_lock_for_expired_deadline(&$u, $chat){
  $st = $u["state"] ?? "";
  if (!preg_match('~^watch_(\d+)_(\d+)$~',$st,$m)) return false; // watch_courseId_step
  $deadline_key = $m[1] . '_' . $m[2];
  $dl = (int)($u["video_deadlines"][$deadline_key] ?? 0);
  if ($dl > 0 && time() > $dl && !user_is_locked($u)){
    $u["lock_until"] = time() + 3*24*3600; // 3 ุฑูุฒ
    tg_sendMessage($chat,"โ๏ธ <b>ูุชุงุณูุงูู ูุญุฏูุฏ ุดุฏ!</b>\n\nุจู ุฏูู ุชูุงู ุดุฏู ูุฑุตุช ดธ ุณุงุนุชู ุจุฑุง ูุดุงูุฏู ูุฏุฆูุ ุดูุง ุชุง <b>ณ ุฑูุฒ ุขูุฏู</b> ููโุชูุงูุฏ ุงุฒ ุฑุจุงุช ุงุณุชูุงุฏู ฺฉูุฏ.\n\nุงฺฏุฑ ูฺฉุฑ ูโฺฉูุฏ ุงุดุชุจุงู ุดุฏูุ ุจู ยซูพุดุชุจุงูยป ูพุงู ุฏูุฏ ุชุง ุณุฑุน ุจุฑุฑุณ ฺฉูู.\n(ูุญุฏูุฏุช ุดูุง ุจุนุฏ ุงุฒ ณ ุฑูุฒ ุฎูุฏฺฉุงุฑ ุจุฑุฏุงุดุชู ูโุดูุฏ)", only_support_kb());
    return true;
  }
  return false;
}

function enforce_restrictions(&$db, &$u, $chat, $isAdminInSupportGroup = false){
  if ($isAdminInSupportGroup) return false; // Admins are never restricted in the support group

  if (user_is_banned($u)){
    tg_sendMessage($chat,"๐ซ ูุชุงุณูุงูู ุฏุณุชุฑุณ ุดูุง ุชูุณุท ูุฏุฑุช ูุณุฏูุฏ ุดุฏู ุงุณุช. ุจุฑุง ูพฺฏุฑ ุจุง ูพุดุชุจุงู ุฏุฑ ุชูุงุณ ุจุงุดุฏ.", only_support_kb());
    return true;
  }
  $changed = maybe_auto_unlock($u, $chat);
  if ($changed) db_save($db);
  if (user_is_locked($u)) {
    tg_sendMessage($chat,"โ๏ธ ุดูุง ุฏุฑ ุญุงู ุญุงุถุฑ ูุญุฏูุฏ ูุณุชุฏ. ูุทูุงู ุชุง ูพุงุงู ุฒูุงู ูุญุฏูุฏุช ุตุจุฑ ฺฉูุฏ ุง ุงุฒ ุทุฑู ยซูพุดุชุจุงูยป ูพฺฏุฑ ฺฉูุฏ.", only_support_kb());
    return true;
  }
  $lockedNow = maybe_lock_for_expired_deadline($u, $chat);
  if ($lockedNow){ db_save($db); return true; }
  return false;
}

function check_and_send_reminders(&$db) {
    $now = time();
    $last_check = $db['last_reminder_check'] ?? 0;

    // Run this check at most once every 30 minutes to avoid overhead
    if ($now - $last_check < 1800) {
        return;
    }
    
    $db['last_reminder_check'] = $now;
    $users_to_remind = [];
    $day_ago = $now - 86400; // 24 hours
    $two_days_ago = $now - 172800; // 48 hours

    foreach ($db['users'] as $uid => &$user) {
        if (
            !($user['reminder_sent'] ?? false) &&
            ($user['created_at'] > $two_days_ago) &&
            ($user['created_at'] < $day_ago)
        ) {
            $free_course_progress = get_user_course_progress($db, $uid, 1);
            if ($free_course_progress['progress'] === -1) {
                $users_to_remind[] = $uid;
            }
        }
    }

    if (!empty($users_to_remind)) {
        log_it("REMINDER: Found " . count($users_to_remind) . " users to remind.");
        $reminder_text = "ุณูุงู! ฺฉ ุงุฏุขูุฑ ุฏูุณุชุงูู...\n\nูููุฒ ุขููุฒุด ููุฏูุงุช ู ุฑุงฺฏุงู ATB ุฑุง ุดุฑูุน ูฺฉุฑุฏูโุง. ุจุง ฺฏุฐุฑุงูุฏู ุงู ุฏูุฑู ณ ูุณูุชุ ูโุชูุงู ูุงุฑุฏ ฺฉุงูุงู ุฎุตูุต ูุง ุดู ู ฺฉู ูุทูุจ ุฌุฏุฏ ุงุฏ ุจฺฏุฑ.\n\nุฑุงุณุชุ ูโุฏุงูุณุช ุจุง ุฏุนูุช ุงุฒ ุฏูุณุชุงูุช ูู ูโุชูุงู ฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑ ุฏุงุดุชู ุจุงุดุ\n\nููุชุดู ุดุฑูุน ฺฉู ๐";
        $reminder_kb = kb([[btn("ุดุฑูุน ุขููุฒุด ููุฏูุงุช ุฑุงฺฏุงู", "start_free_course")], [btn("ฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑ", "referral_menu")]]);
        
        foreach($users_to_remind as $uid) {
            tg_sendMessage($uid, $reminder_text, $reminder_kb);
            $db['users'][$uid]['reminder_sent'] = true;
            usleep(300000); // Prevent hitting API limits
        }
        db_save($db);
    }
}
/* ==== EXTRA HELPERS END ========================================== */

/* ==== UI TEXTS START ============================================= */
function welcome_text(){
  return "ุณูุงู! ๐\n"
    ."ุจู ุฑุจุงุช ุชุฎุตุต <b>ATB Club</b> ุฎูุด ุขูุฏ.\n\n"
    ."ุงูุฌุง ุงุฏ ูโฺฏุฑ ฺุทูุฑ ุจุง ููุด ูุตููุนุ ฺฉุณุจโูฺฉุงุฑุช ุฑุง ูุชุญูู ฺฉู ู ุฏุฑุขูุฏุช ุฑุง ุงูุฒุงุด ุฏู.\n\n"
    ."ุจุฑุง ุดุฑูุนุ ุงุฒ ููู ุฒุฑ ุงุณุชูุงุฏู ฺฉู.";
}
function about_text(){
  global $PUBLIC_CHANNEL_ID;
  return "<b>ุฏุฑุจุงุฑู ATB Club</b>\n\n"
        ."ูุง ุงูุฌุง ูุณุชู ุชุง ุจู ุดูุง ูุดุงู ุฏูู ููุด ูุตููุน ฺฉ ุงุจุฒุงุฑ ูพฺุฏู ูุณุชุ ุจูฺฉู ฺฉ ุฏุณุชุงุฑ ูููโุงูุนุงุฏู ุจุฑุง ุฑุดุฏ ฺฉุงุฑ ู ุฒูุฏฺฏ ุดูุงุณุช. ุจุง ุขููุฒุดโูุง ุนูู ู ูพุดุชุจุงู ูุงูุนุ ฺฉูฺฉุชุงู ูโฺฉูู ุฎุฑูุฌโูุง ููููุณ ุจุณุงุฒุฏโ"
        ."ุงุฒ ุชููุฏ ูุญุชูุง ูุฑูุณ ฺฏุฑูุชู ุชุง ุงุชููุงุชฺฉ ฺฉุฑุฏู ฺฉุงุฑูุง ุชฺฉุฑุงุฑ.\n\n"
        ."<b>ุงูุฌุง ุจุฑุง ฺู ฺฉุณุงู ููุฏ ุงุณุชุ</b>\n"
        ."ูุฑููุณุฑูุงุ ุตุงุญุจุงู ูุฑูุดฺฏุงูโูุง ุขููุงูุ ุชููุฏฺฉููุฏฺฏุงู ูุญุชูุง ู ูุฑ ฺฉุณ ฺฉู ูโุฎูุงูุฏ ุจุง AI <b>ุณุฑุนโุชุฑุ ููุดููุฏุชุฑ ู ุจุงฺฉูุชโุชุฑ</b> ฺฉุงุฑ ฺฉูุฏ.\n\n"
        ."<b>ูุฏู ููุง ูุงุ</b>\n"
        ."ุงูฺฉู ุฏุงูุด ุฑุง ุจู ุฏุฑุขูุฏ ุชุจุฏู ฺฉูุฏ. ุจุง ฺฉูุชุฑู ุฒูุงูุ ุจุดุชุฑู ูุชุฌู ุฑุง ุจฺฏุฑุฏ.\n\n"
        ."ุจุฑุง ุงุทูุงุน ุงุฒ ุขุฎุฑู ุงุฎุจุงุฑ ู ุฏูุฑูโูุงุ ุญุชูุง ฺฉุงูุงู ุนููู ูุง ุฑุง ุฏูุจุงู ฺฉูุฏ: " . $PUBLIC_CHANNEL_ID;
}
function ctfc_prompt(){
  return <<<CTFC
ุชู ููุด ฺฉ ุงุณุชุฑุงุชฺุณุช ุญุฑููโุง ูุงุฑุงูโุณุงุฒ ูุญุชูุง ุฑู ุฏุงุฑ ฺฉู ุชุฑฺฉุจ ุงุฒ ุฐููุ Alex Hormozi ู Donald Miller ูุณุช. ูโุฎูุงู ุจุง ฺฉูฺฉ ูุฏู CTFC (ุฏุบุฏุบูุ ุชฺฉูฺฉุ ูุฑูุ ูุญุชูุง) ฺฉ ูุญุชูุง ูููู ุจุฑุง ูพุฌ ุฎูุฏู ุชููุฏ ฺฉูู.
๐ุญูุฒู ฺฉุงุฑ ูู: ุฑูฺฏ ู ูุงุช
ูุฎุงุทุจู ูุฏูู: ุฎุงูู ูุง ุชู ุณูู ูุฎุชูู ูุณุชู

---

## ๐ฃ ูุฑุญูู ุงูู: ุฏุบุฏุบู ูุฎุงุทุจ (Concern)

ุงูู ุจุง ุฏุบุฏุบู ูุงูุน ูุฎุงุทุจ ุฑู ูพุฏุง ฺฉููุ ุฏุบุฏุบูโุง ฺฉู:
- ูุงูุนุงู ุชู ุฐูู ูุฎุงุทุจ ูุณุชุ ูู ููโุชููู ุฏุฑุณุช ุจุงูุด ฺฉูู
- ุฌูุฑ ููุดุชู ุดุฏู ุจุงุดู ฺฉู ููุช ูุฎุงุทุจ ุจุจูู ุจฺฏู: ยซุงู ุฏููุงู ูุดฺฉู ูููยป
- ุจู ุฒุจุงู ุฎูุฏ ูุฎุงุทุจ ุจุงุดูุ ูู ฺฉููุงุช ุฎุดฺฉ ู ุฑุณู

โ๏ธุงฺฏู ุฎูุฏู ุฏุบุฏุบู ุฏุงุฑูุ ุตุจุฑ ูฺฉูุ ูุณุชูู ุจุฑู ุณุฑุงุบ ูุฑุญูู ุจุนุฏ.
โ๏ธุงฺฏุฑ ุฏุบุฏุบู ูุฏุงุฑูุ ูุทูุงู ุงูู ฑฐ ุชุง ุฏุบุฏุบู ุฏุงุบ ู ูุงุฑุงูโุณุงุฒ ูุฎุตูุต ุญูุฒู ูู ูพุดููุงุฏ ุจุฏู. ุงฺฏู ุฎูุงุณุชูุ ุจุนุฏุด ุงุฒุช ูโุฎูุงู ฑฒฐ ุชุง ุฏฺฏูโุด ุฑู ุฏุณุชูโุจูุฏโุดุฏู ุจุฏู.
---

## ๐ฃ ูุฑุญูู ุฏูู: ุชฺฉูฺฉ ุงุฌุฑุง (Technique)

ููุช ุฏุบุฏุบู ุงูุชุฎุงุจ ุดุฏุ ุจุฑู ุณุฑุงุบ ุงูุชุฎุงุจ ุชฺฉูฺฉ ฺฉู ุจุง ุงูู ุฏุบุฏุบู ุชุฑฺฉุจ ุจุดู ู ูุญุชูุง ูุงุฑุงู ุจุณุงุฒู. ูุทูุงู ูุณุช ฺฉุงูู ฒด ุชฺฉูฺฉ ูุงุฑุงู ุฒุฑ ุฑู ุจุฑุงู ุจุงุฑุ ู ุจุนุฏ ุจูโุนููุงู ูพุดููุงุฏุ ุจููุณ ฺฉุฏูู ุชฺฉูฺฉ ุจุฑุง ุฏุบุฏุบู ูู ููุงุณุจู ู ู ูุซุงู ฺฉูุชุงู ุงุฒ ุดุฑูุน ุงูู ูพุณุช ูู ุจุฏู.
โ ุชฺฉูฺฉโูุง CTFC:

1. ุฑูู (ููุฏ ู ุจุฑุฑุณ ฺฉ ฺุฒ)
2. ุฏุงุณุชุงู (ูุงูุน ุง ุณุงุฎุชฺฏ)
3. ุชุถุงุฏ (ุจุงูุฑ ุบูุท vs ุญููุช)
4. To Do (ูุณุช ุจุงุฏูุง)
5. ุงุชุตุงู ุนููู (ุฑุจุท ุจู ููุถูุนุงุช ุนููู ุง ุงุฌุชูุงุน)
6. ูุงูฺฏุฑ (ูพุดโุจู ุดุฎุตุช ุง ุฑูุชุงุฑ)
7. ููุงุณู (ฺุฒ ุจุง ฺุฒ ุฏฺฏุฑ)
8. ุฏูุฑุงู (ฺฉุฏููโุฑู ุงูุชุฎุงุจ ูโฺฉูุ)
9. ููุฒุงุฏูพูุฏุงุฑ (ุงุฒ ุฒุจุงู ูุฎุงุทุจ ฺฏูุชู)
10. 3 IF (ุงฺฏุฑ ููุงู + ุงฺฏุฑ ูู + ฺ ูุดูุ)
11. ููุช (ุฒูุงู / ุชุนุฏุงุฏ / ูุญุฏูุฏุช)
12. ูุดุฏุงุฑ (ุชููโูุดุฏุงุฑ)
13. ุชุนูู (ู ฺุฒ ูุณุช ฺฉู ููโุฏูู...)
14. ุชุตูุฑ ุนุฌุจ (ุดูฺฉ ุจุตุฑ)
15. ุญุฑููโุง/ูุจุชุฏ (ููุงุณู ุฏู ุชูพ ุขุฏู)
16. ูุซุงู ูุงุจู ููุงุด (ูุซุงู ุนู ู ูุงูุน)
17. ุชููู (ููุงุณุจุช)
18. ุณูุงู ุชูู (ุณูุงู ฺฉูุฌฺฉุงูฺฉููุฏู)
19. ุชุฌุฑุจู ูุดุชุฑฺฉ (ยซุญุชูุงู ุจุฑุงุช ูพุด ุงููุฏู ฺฉู...ยป)
20. ุจฺฉโุงุณุชุฌ (ูพุดุช ุตุญูู ุฎูุฏู/ฺฉุณุจโูฺฉุงุฑู)
21. ุชุฎุฑุจ ูุญุชุฑูุงูู (ููุฏ ููุฏุจุงูู ุจุงูุฑูุง ุบูุท)
22. ุดุจูโุณุงุฒ ุฐูู (ูุฑุถ ฺฉู ุงูุฌูุฑ ูโุดุฏ...)
23. ุฎูุฏูโุฏุงุฑ ุฌุฏ (ุทูุฒ ุฌุฏ)
24. ุขููุฒุด ุจุฒูุณ ุฏุฑ ูุงูุจ ุฏุงุณุชุงู (ุขููุฒุด ุฏุฑ ุฏู ฺฉ ุฑูุงุช)

---

## ๐ฃ ูุฑุญูู ุณูู: ูุฑู ุงุฌุฑุง (Format)

ุญุงูุง ุจฺฏู ุงู ุชฺฉูฺฉ ุฑู ุจุง ฺู ูุฑู ุงุฌุฑุง ฺฉูู ฺฉู ูุฎุงุทุจ ุชุง ุขุฎุฑ ุจุจูู ู ูุญุชูุง ูู ููู ูุดูุ
๐งฉ ูุณุช ูุฑูโูุง ุงุฌุฑุง:

- ุฏููุงุจ (ูุจู / ุจุนุฏ ุง ุฏุฑุณุช / ุบูุท)
- ุฏฺฉููพุงฺ (ฺูุฏ ุตุญูู ูพุดุชโุณุฑ ูู)
- ฺฉูุงฺ (ุชุฑฺฉุจ ุนฺฉุณุ ุตุฏุง ู ูุชู)
- ฺฉูุงุณ (ูุซู ูุนูู ุง ูุงุชโุจุฑุฏ)
- ูพูฺฏ ูพูฺฏ (ุฏุงููฺฏ ุฏู ููุฑู)
- ูุฏุฆูฺฉุณุช (ุงุฑุงุฆู ุฑุณู)
- ููุงฺฏ (ุฒูุฏฺฏ ูุงูุน ุฎูุฏุช)
- ุฏุณุชโุฎุท (ููุดุชู ุฑู ฺฉุงุบุฐ ุจุง ุตุฏุง ุฎูุฏุช)

๐ ูุทูุงู ููุงุณุจโุชุฑู ูุฑู ุฑู ุจุฑ ุงุณุงุณ ุฏุบุฏุบู + ุชฺฉูฺฉ ูู ูพุดููุงุฏ ุจุฏู.
---

## ๐ฃ ูุฑุญูู ููุง: ุณุงุฎุชุงุฑ ูุญุชูุง ููุง (Content)

ุฏุฑ ููุงุชุ ุจุง ุชูุงู ุงุทูุงุนุงุช ุจุงูุงุ ูุทูุงู ุณุงุฎุชุงุฑ ฺฉ ูพุณุช ุง ุฑูุฒ ููุง ุจุฑุง ูู ุจุณุงุฒ. ุดุงูู:
- ุนููุงู
- ููุงุจ ุดุฑูุน
- ุณุงุฎุชุงุฑ ุจุฏูู
- ุฌููู ูพุงุงู

ูุฎุงุทุจ ูู ุจุงุฏ ุจุนุฏ ุฏุฏู ุงู ูุญุชูุง ุจฺฏู:
ยซูุง ุฏููุงู ุญุฑู ุฏู ูู ุจูุฏโฆ ุจุงุฏ ูุงูู ฺฉูู ุง ูพฺฏุฑ ุจุดูยป

ูุทูุงู ุขูุงุฏู ุจุงุด ุจุฑุง ุงูฺฉู ุจุง ููู ูุฑูููุ ูุญุชูุงูุง ุจุนุฏ ุฑู ูู ฺฉโฺฉ ุจุณุงุฒู.
CTFC;
}
function sendCTFC($chat){
  $p = ctfc_prompt();
  tg_sendMessage($chat, $p, kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช","back_to_menu")]]));
}
function faq_items(){
  return [
    "q1" => ["q"=>"๐ค ฺุทูุฑ ChatGPT ุฑู ูุตุจ ฺฉููุ","a"=>"ุฎู ุฑุงุญุช! ุงุฒ ููู ุงุตู ูุงุฑุฏ ยซ๐งฐ ุงุจุฒุงุฑฺฉยป ุดู. ุขูุฌุง ููฺฉโูุง ูุณุชูู ูุตุจ ุงุฒ ุงูพ ุงุณุชูุฑ ู ฺฏูฺฏู ูพู ุฑุง ูุฑุงุฑ ุฏุงุฏูโุงู."],
    "q2" => ["q"=>"๐ ฺุฑุง ููฺฉ ฺฉุงูุงู ุฎุตูุต ุจุฑุงู ุงุฑุณุงู ููโุดูุฏุ","a"=>"ุจู ูุญุถ ุงูฺฉู ุชูุฑูโูุง ุฏูุฑู ููุฏูุงุช ุฑุง ุจูุฑุณุช ู ูพุดุชุจุงู ุขูโูุง ุฑุง ุชุงุฏ ฺฉูุฏุ ููฺฉ ุนุถูุช ุจุฑุงุช ูุนุงู ูโุดูุฏ."],
    "q3" => ["q"=>"๐ต ฺุทูุฑ ููฺฉ ฺฉุณุจ ุฏุฑุขูุฏ ุฎูุฏู ุฑุง ุจฺฏุฑูุ","a"=>"ุงุฒ ููู ุงุตู ุฑู ุฏฺฉูู ยซ๐ต ฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑยป ุจุฒู ุชุง ููฺฉ ุฏุนูุช ุงุฎุชุตุงุต ุฎูุฏุช ุฑุง ุฏุฑุงูุช ฺฉู ู ุจุฑุง ุฏูุณุชุงูุช ุจูุฑุณุช."],
    "q4" => ["q"=>"๐ค ูพุงุฏุงุด ุฏุนูุชู ฺฉ ุจู ุญุณุงุจู ูุงุฑุฒ ูโุดูุฏุ","a"=>"ููุช ุฏูุณุช ฺฉู ุฏุนูุช ฺฉุฑุฏุ ูุฑ ุณู ูุฑุญูู ุขููุฒุด ููุฏูุงุช ุฑุง ุจุง ููููุช ุชูุงู ฺฉูุฏุ ูพุงุฏุงุด ุฏูุงุฑ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู ฺฉู ูพููุช ุฏุฑ ุฑุจุงุช ุงุถุงูู ูโุดูุฏ. ุจุฑุง ุชุณูู ุญุณุงุจุ ฺฉุงู ุงุณุช ุจู ูพุดุชุจุงู ูพุงู ุฏู."],
    "q5" => ["q"=>"๐ ฺุทูุฑ ูโุชูุงูู ุงุดุชุฑุงฺฉ VIP ุจุฎุฑูุ","a"=>"ุงุฒ ููู ุงุตู ยซ๐ ุงุดุชุฑุงฺฉ VIPยป ุฑุง ุงูุชุฎุงุจ ฺฉูุ ูุจูุบ ูพูู ููุฑุฏ ูุธุฑุช ุฑุง ุจู ฺฉุงุฑุช ฺฉู ุงุทูุงุนุงุชุด ุฏุงุฏู ุดุฏู ูุงุฑุฒ ฺฉู ู ุนฺฉุณ ุฑุณุฏ ุฑุง ููุงูุฌุง ุจุฑุง ูุง ุจูุฑุณุช. ุจุนุฏ ุงุฒ ุชุงุฏุ ุฏุณุชุฑุณ VIP ุจุฑุงุช ูุนุงู ูโุดูุฏ."],
    "q6" => ["q"=>"โณ ุชุงุฏ ุชูุฑูโูุง ุง ุฑุณุฏ ฺูุฏุฑ ุทูู ูโฺฉุดุฏุ","a"=>"ุชู ูพุดุชุจุงู ูุง ููุดู ุขููุงู ุงุณุช ู ุณุน ูโฺฉูุฏ ุฏุฑ ุณุฑุนโุชุฑู ุฒูุงู ููฺฉู (ูุนูููุงู ฺฉูุชุฑ ุงุฒ ฺูุฏ ุณุงุนุช) ุฏุฑุฎูุงุณุชโูุง ุฑุง ุจุฑุฑุณ ฺฉูุฏ."],
    "q7" => ["q"=>"๐ ูโุชูุงูู ุฏูุฑูโูุง ุฑุง ุงุฒ ุงูู ุดุฑูุน ฺฉููุ","a"=>"ุจูู ุญุชูุง! ฺฉุงู ุงุณุช ุจู ูพุดุชุจุงู ูพุงู ุฏู ู ุงุฒ ุขูโูุง ุจุฎูุงู ูุถุนุชุช ุฑุง ุฑุณุช ฺฉููุฏ ุชุง ููู ฺุฒ ุงุฒ ูู ุดุฑูุน ุดูุฏ."],
    "q8" => ["q"=>"๐ ุงุทูุงุนุงุช ูู ุงูุฌุง ุงูู ุงุณุชุ","a"=>"ุตุฏ ุฏุฑ ุตุฏ! ูุง ููุท ุงุทูุงุนุงุช ฺฉู ุจุฑุง ูพุดุฑูุช ุขููุฒุด ุดูุง ู ูพุดุชุจุงู ูุงุฒู ุงุณุช ุฑุง ุฐุฎุฑู ูโฺฉูู ู ุจู ูฺ ุนููุงู ุฏุฑ ุงุฎุชุงุฑ ฺฉุณ ูุฑุงุฑ ููโุฏูู."]
  ];
}
function faq_menu_kb(){
  $items = faq_items(); $rows = [];
  foreach($items as $k=>$it){
    $rows[] = [ ["text"=>"โข ".$it["q"], "callback_data"=>"faq:".$k] ];
  }
  $rows[] = [ ["text"=>"โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","callback_data"=>"back_to_menu"] ];
  return json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE);
}
function main_menu(){
  return kb([
    [btn("๐ ุขููุฒุด ููุฏูุงุช ุฑุงฺฏุงู", "start_free_course")],
    [btn("๐ฐ ุขููุฒุดโูุง ูพููุณุงุฒ", "paid_courses")],
    [btn("๐ ุงุดุชุฑุงฺฉ VIP", "vip_membership")],
    [btn("๐ก ููุดููุฏุณุงุฒ ฺฉุณุจโูฺฉุงุฑ", "biz_automation_start")],
    [btn("๐ต ฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑ", "referral_menu"), btn("๐ค ุญุณุงุจ ฺฉุงุฑุจุฑ", "account_menu")],
    [btn("๐งฐ ุงุจุฒุงุฑฺฉ", "toolkit"), btn("โ ุณูุงูุงุช ูุชุฏุงูู", "faq")],
    [btn("๐ ูพุดุชุจุงู", "support_contact"), btn("โน๏ธ ุฏุฑุจุงุฑู ูุง", "about")],
  ]);
}
function admin_exercise_kb($userId, $courseId, $step){
  return kb([[ btn("โ ุชุฃุฏ ุชูุฑู", "admin_ex_ok:{$userId}:{$courseId}:{$step}"), btn("โ ุฑุฏ ฺฉุฑุฏู", "admin_ex_no:{$userId}:{$courseId}:{$step}") ]]);
}
function admin_receipt_kb($userId, $courseId){
    return kb([[ btn("โ ุชุฃุฏ ุฑุณุฏ", "admin_receipt_ok:{$userId}:{$courseId}"), btn("โ ุฑุฏ ุฑุณุฏ", "admin_receipt_no:{$userId}:{$courseId}") ]]);
}
function admin_vip_receipt_kb($userId, $sub_type){
    return kb([[ btn("โ ุชุฃุฏ ูพุฑุฏุงุฎุช VIP", "admin_vip_ok:{$userId}:{$sub_type}") ]]);
}
function admin_support_kb($userId){
  return kb([[ btn("โ๏ธ ูพุงุณุฎ ุจู ุงู ฺฉุงุฑุจุฑ","support_reply:".$userId) ]]);
}
function toolkit_kb(){
  $db = db_load();
  $buttons = $db['toolkit_buttons'] ?? [];
  if (empty($buttons)) {
      $buttons = get_default_toolkit_buttons();
      $db['toolkit_buttons'] = $buttons;
      db_save($db);
  }
  $rows = [];
  foreach ($buttons as $btnData) {
      if (isset($btnData['text'], $btnData['type'], $btnData['value'])) {
          if ($btnData['type'] === 'url') {
              $rows[] = [ ['text' => $btnData['text'], 'url' => $btnData['value']] ];
          } elseif ($btnData['type'] === 'callback') {
              $rows[] = [ ['text' => $btnData['text'], 'callback_data' => $btnData['value']] ];
          }
      }
  }
  $rows[] = [ ["text"=>"๐งฉ ูพุฑุงููพุช ุฌุงุฏู CTFC","callback_data"=>"toolkit_ctfc"] ];
  $rows[] = [ ["text"=>"โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","callback_data"=>"back_to_menu"] ];
  return json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE);
}

function send_course_step(&$db, $chat_id, $course_id, $step_index) {
    $course = get_course_by_id($db, $course_id);
    if (!$course || !isset($course['content'][$step_index])) {
        tg_sendMessage($chat_id, "ูุชุงุณูุงูู ูุดฺฉู ูพุด ุขูุฏู. ูุฑุญูู ููุฑุฏ ูุธุฑ ูพุฏุง ูุดุฏ.");
        return;
    }

    $step_content = $course['content'][$step_index];
    $user =& user($db, $chat_id);
    $user['state'] = "watch_{$course_id}_{$step_index}";
    $user['watch_started_at'] = time();
    $user['video_deadlines'][$course_id . '_' . $step_index] = time() + 48 * 3600;

    $is_free_course = ($course['price'] == 0);
    $button_text = $is_free_course ? "โ ูุฏุฆู ุฑุง ุฏุฏูุ ุจุฑูู ุจุฑุง ุชูุฑู!" : "โ ูุดุงูุฏู ฺฉุฑุฏูุ ุจุฑูู ูุฑุญูู ุจุนุฏ";
    $callback_data = "seen_step:{$course_id}:{$step_index}";
    $keyboard = kb([[btn($button_text, $callback_data)],[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","back_to_menu")]]);

    if ($step_content['type'] === 'video') {
        tg_sendVideo($chat_id, $step_content['file_id'], $step_content['caption'], $keyboard);
    } else {
        tg_sendMessage($chat_id, $step_content['caption'], $keyboard);
    }
    db_save($db);
}
/* ==== UI TEXTS END =============================================== */

/* ==== INPUT START ================================================= */
$__exp = getenv('TG_SECRET_TOKEN');
$__got = $_SERVER['HTTP_X_TELEGRAM_BOT_API_SECRET_TOKEN'] ?? '';
if ($__exp && !hash_equals($__exp, $__got)) { http_response_code(403); echo "forbidden"; exit; }
$raw = file_get_contents("php://input");
log_it("RAW: ".$raw);
$update = json_decode($raw, true);
http_response_code(200); echo "OK";
/* ==== INPUT END =================================================== */

/* ==== ADMIN QUICK HELPERS ======================================== */
function format_sub_status(&$db, $uid){
  $s = $db["subscriptions"][$uid] ?? null;
  if(!$s) return "ูุฏุงุฑุฏ";
  $type = $s["type"] ?? "none";
  if($type==="none") return "ูุฏุงุฑุฏ";
  $exp = isset($s["expires_at"]) ? to_jalali((int)$s["expires_at"]) : "โ";
  $label = ["3m"=>"ณ ูุงูู","6m"=>"ถ ูุงูู","12m"=>"ฑฒ ูุงูู"][$type] ?? $type;
  return "<b>".$label."</b> (ุชุง ".$exp.")";
}
function admin_user_summary($uid, &$uu, &$db){
  $free_course_progress = get_user_course_progress($db, $uid, 1);
  $p_step = ($free_course_progress['progress'] ?? -1) + 1;
  $p_total = count(get_course_by_id($db, 1)['content'] ?? []);
  $progress_text = ($p_step >= $p_total) ? "ุชฺฉูู ุดุฏู โ" : "ูุฑุญูู {$p_step} ุงุฒ {$p_total}";
  
  $sub  = format_sub_status($db, $uid);
  $status = $uu["state"] ?? "-";
  $lock_until_jalali = !empty($uu["lock_until"]) ? to_jalali($uu["lock_until"]) : '';
  $lock = user_is_locked($uu) ? "โ๏ธ ูุญุฏูุฏ ุชุง ".$lock_until_jalali : "ุขุฒุงุฏ";
  $ban  = user_is_banned($uu) ? "๐ซ ุจูโุดุฏู" : "โ";
  $reg  = isset($uu["created_at"]) ? to_jalali($uu["created_at"]) : "โ";
  $ref_balance = ($uu['referral_balance_usd'] ?? 0);

  $courses_info = [];
  if(isset($db['user_courses'][$uid])){
      foreach($db['user_courses'][$uid] as $cid => $cdata){
          if ($cid == 1) continue; // Skip free course
          $course = get_course_by_id($db, $cid);
          $title = $course['title'] ?? "ุฏูุฑู {$cid}";
          $courses_info[] = "โข {$title} ({$cdata['status']})";
      }
  }
  $courses_text = empty($courses_info) ? "โ" : "\n" . implode("\n", $courses_info);

  return "๐ค <b>ูพุฑููุงู ฺฉุงุฑุจุฑ: <a href='tg://user?id={$uid}'>{$uid}</a></b>\n"
        ."ูุงู: <b>".(($uu["name"]??'-')?:'-')."</b> | ุดูุงุฑู: <code>".(($uu["phone"]??'-')?:'-')."</code>\n"
        ."ุดุบู: ".($uu["job"]??'-')." | ุณุทุญ AI: ".($uu["ai"]??'-')."\n"
        ."ุชุงุฑุฎ ุซุจุชโูุงู: <b>{$reg}</b>\n\n"
        ."๐ ุงุดุชุฑุงฺฉ VIP: {$sub}\n"
        ."๐ต ุฏุฑุขูุฏ ุฏุนูุช: <b>{$ref_balance} ุฏูุงุฑ</b>\n\n"
        ."๐ ูพุดุฑูุช ุฏูุฑู ุฑุงฺฏุงู: <b>{$progress_text}</b>\n"
        ."๐ฐ ุฏูุฑูโูุง ฺฉุงุฑุจุฑ: {$courses_text}\n\n"
        ."<b>ูุถุนุช ูู:</b>\nState: <code>{$status}</code> | Lock: {$lock} | Ban: {$ban}";
}
function admin_user_kb($uid,&$uu){
  $banBtn = user_is_banned($uu) ? ["text"=>"โ ุฑูุน ุจู","callback_data"=>"au:unban:".$uid] : ["text"=>"๐ซ ุจู ฺฉุฑุฏู","callback_data"=>"au:ban:".$uid];
  return json_encode(["inline_keyboard"=>[
    [ ["text"=>"๐ ุชุงุฒูโุณุงุฒ ุงุทูุงุนุงุช","callback_data"=>"au:info:".$uid] ],
    [ ["text"=>"๐ ูุฏุฑุช ุฏูุฑู ุฑุงฺฏุงู","callback_data"=>"au:manage_free:".$uid] ],
    [ ["text"=>"๐ ูุฏุฑุช ุงุดุชุฑุงฺฉ VIP","callback_data"=>"au:sub_menu:".$uid] ],
    [ ["text"=>"๐ ุชุบุฑ ูุงู","callback_data"=>"au:rename:".$uid], $banBtn ],
    [ ["text"=>"๐ ุฑูุน ูุญุฏูุฏุช (ุฏุฏูุงู)","callback_data"=>"au:unlock:".$uid] ],
    [ ["text"=>"โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ุงุตู","callback_data"=>"ap:panel_main"] ]
  ]], JSON_UNESCAPED_UNICODE);
}

function admin_commands_text(){
  return "๐ <b>ุฑุงูููุง ุฏุณุชูุฑุงุช ุงุฏูู (ูุณุฎู ".ATB_VERSION.")</b>\n\n"
        ."ุงู ุฏุณุชูุฑุงุช ุฑุง ูโุชูุงู ูุณุชููุงู ุฏุฑ ฺุช ุจุง ุฑุจุงุช ุง ฺฏุฑูู ุงุฏููโูุง ุงุฑุณุงู ฺฉู.\n\n"
        ."<b>--- ูุฏุฑุช ฺฉู ---</b>\n"
        ."โซ๏ธ /panel\n"
        ."ููุงุด ูพูู ุงุตู ูุฏุฑุช ุจุง ุฏฺฉููโูุง ฺฉุงุฑุจุฑุฏ.\n\n"
        ."โซ๏ธ /user <code>&lt;ุดูุงุณู ุนุฏุฏ&gt;</code>\n"
        ."ูุซุงู: <code>/user 12345678</code>\n"
        ."ููุงุด ูพูู ูุฏุฑุช ุงุฎุชุตุงุต ุจุฑุง ฺฉุงุฑุจุฑ ููุฑุฏ ูุธุฑ.\n\n"
        ."<b>--- ูุฏุฑุช ุงุฏููโูุง ---</b>\n"
        ."โซ๏ธ /adminlist\n"
        ."ููุงุด ูุณุช ุดูุงุณูโูุง ุนุฏุฏ ุชูุงู ุงุฏููโูุง ุฑุจุงุช.\n\n"
        ."โซ๏ธ /makeadmin (ุจุง ุฑูพูุง ุฑู ูพุงู ฺฉุงุฑุจุฑ)\n"
        ."ฺฉุงุฑุจุฑ ููุฑุฏ ูุธุฑ ุฑุง ุจู ูุณุช ุงุฏููโูุง ุงุถุงูู ูโฺฉูุฏ.\n\n"
        ."โซ๏ธ /removeadmin (ุจุง ุฑูพูุง ุฑู ูพุงู ฺฉุงุฑุจุฑ)\n"
        ."ุงุฏูู ููุฑุฏ ูุธุฑ ุฑุง ุงุฒ ูุณุช ุญุฐู ูโฺฉูุฏ.\n\n"
        ."โซ๏ธ /adminlogin <code>&lt;ุดูุงุฑู ููุจุงู&gt;</code>\n"
        ."ูุซุงู: <code>/adminlogin 09123456789</code>\n"
        ."ุงฺฏุฑ ุดูุงุฑู ุดูุง ุฏุฑ ูุณุช ุงุฏููโูุง ุงุตู ุฏุฑ ฺฉุฏ ุฑุจุงุช ุซุจุช ุดุฏู ุจุงุดุฏุ ุงู ุฏุณุชูุฑ ุจู ุดูุง ุฏุณุชุฑุณ ุงุฏูู ูโุฏูุฏ.\n\n"
        ."๐ก <b>ูฺฉุชู:</b> ุจุดุชุฑ ูุงุจูุชโูุง ุงุฒ ุทุฑู ุฏฺฉููโูุง ฺฏุฑุงูฺฉ ูพูู ูุฏุฑุช ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏ ู ูุงุฒ ุจู ุชุงูพ ุฏุณุชูุฑ ูุฏุงุฑูุฏ.";
}
/* ==== MSG_HANDLER START ========================================== */
if(isset($update["message"])){
  $db      = db_load();
  add_missing_courses_if_needed($db); // Ensure default courses exist
  $chat    = $update["message"]["chat"]["id"];
  $fromId  = $update["message"]["from"]["id"] ?? null;
  $text    = trim($update["message"]["text"] ?? "");
  $u       =& user($db,$fromId); // Use fromId for user context
  $isAdmin = is_admin($db, $fromId);
  $isSupportGroup = (string)$chat === (string)$SUPPORT_CHAT;
  
  // Run pseudo-cron for reminders
  check_and_send_reminders($db);

  // --- Admin Commands First ---
  if ($isAdmin) {
      if ($text === "/panel" || ($text === "/start" && $isSupportGroup)) {
          $all = $db["users"] ?? [];
          $total = count($all);
          $todayStart = strtotime('today');
          $today = 0;
          foreach($all as $id=>$uu){ if( (int)($uu["created_at"]??0) >= $todayStart ) $today++; }
          $pendingExCount = count($db["pending_exercises"] ?? []);
          $pendingRecCount = count($db["pending_receipts"] ?? []);
          $pendingBizCount = count(array_filter($db["business_automation_requests"] ?? [], fn($r) => $r['status'] === 'pending'));
          $openTickets  = count($db["support_open"] ?? []);
          $msg = "๐๏ธ <b>ูพูู ูุฏุฑุช ATB</b> โ ูุณุฎู ".ATB_VERSION."\n\n"
                   . "๐ฅ ฺฉู ฺฉุงุฑุจุฑุงู: <b>{$total}</b> | ุงูุฑูุฒ: <b>{$today}</b>\n"
                   . "โณ ุชูุฑูโูุง ุฏุฑ ุตู: <b>{$pendingExCount}</b>\n"
                   . "๐งพ ุฑุณุฏูุง ุฏุฑ ุตู: <b>{$pendingRecCount}</b>\n"
                   . "๐ก ุฏุฑุฎูุงุณุชโูุง ููุดููุฏุณุงุฒ: <b>{$pendingBizCount}</b>\n"
                   . "๐ฅ ุชฺฉุชโูุง ูพุดุชุจุงูู ุจุงุฒ: <b>{$openTickets}</b>";
          $kb = json_encode(["inline_keyboard"=>[
            [ ["text"=>"๐ ุชุงุฒูโุณุงุฒ ุขูุงุฑ","callback_data"=>"ap:stats"] ],
            [ ["text"=>"๐ ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู","callback_data"=>"ap:export_menu"] ],
            [ ["text"=>"โณ ุจุฑุฑุณ ุชูุฑูโูุง","callback_data"=>"ap:pending_exercises"], ["text"=>"๐งพ ุจุฑุฑุณ ุฑุณุฏูุง","callback_data"=>"ap:pending_receipts"] ],
            [ ["text"=>"๐ก ุฏุฑุฎูุงุณุชโูุง ููุดููุฏุณุงุฒ","callback_data"=>"ap:biz_auto_requests"] ],
            [ ["text"=>"๐ฅ ุชฺฉุชโูุง ุจุงุฒ","callback_data"=>"ap:support_open"] ],
            [ ["text"=>"๐ ูุฏุฑุช ุฏูุฑูโูุง", "callback_data"=>"ap:manage_courses"], ["text"=>"๐ ูุฏุฑุช ุงุดุชุฑุงฺฉโูุง","callback_data"=>"ap:subs_info"] ],
            [ ["text"=>"๐ข ูพุงู ููฺฏุงู","callback_data"=>"ap:broadcast"] ],
            [ ["text"=>"๐งฐ ุงุจุฒุงุฑฺฉ", "callback_data"=>"ap:manage_toolkit"], ["text"=>"๐ผ๏ธ ุฑุณุงูู ุงุณุชุงุฑุช", "callback_data"=>"ap:manage_start_media"] ],
            [ ["text"=>"๐ณ ฺฉุงุฑุช ุจุงูฺฉ","callback_data"=>"ap:set_vip_card"] ],
            [ ["text"=>"๐ ุฑุงูููุง ุฏุณุชูุฑุงุช","callback_data"=>"ap:commands"] ]
          ]], JSON_UNESCAPED_UNICODE);
          tg_sendMessage($chat, $msg, $kb);
          db_save($db); return;
      }
      if (preg_match('~^/user\s+(\d+)$~',$text,$m)){
        $uid = (int)$m[1];
        if(!isset($db["users"][$uid])){ tg_sendMessage($chat,"ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ."); return; }
        $target_user_ref = &user($db, $uid); // Get reference to target user
        tg_sendMessage($chat, admin_user_summary($uid, $target_user_ref, $db), admin_user_kb($uid, $target_user_ref));
        return;
      }
      if (isset($update["message"]["reply_to_message"])) {
          if (trim($text) === "/makeadmin") {
              $targetId = $update["message"]["reply_to_message"]["from"]["id"] ?? null;
              if ($targetId) {
                  if (!in_array((int)$targetId, $db["admin_ids"], true)) {
                      $db["admin_ids"][] = (int)$targetId;
                      db_save($db);
                      tg_sendMessage($chat, "โ ฺฉุงุฑุจุฑ {$targetId} ุจู ุงุฏููโูุง ุฑุจุงุช ุงุถุงูู ุดุฏ.");
                  } else {
                      tg_sendMessage($chat, "โน๏ธ ุงู ฺฉุงุฑุจุฑ ุงุฒ ูุจู ุงุฏูู ุงุณุช.");
                  }
              } else {
                  tg_sendMessage($chat, "โ๏ธ ุฑู ูพุงู ุดุฎุต ููุฑุฏูุธุฑ ุฑูพูุง ฺฉู ู ุฏูุจุงุฑู /makeadmin ุจุฒู.");
              }
              return;
          }
          if (trim($text) === "/removeadmin") {
              $targetId = $update["message"]["reply_to_message"]["from"]["id"] ?? null;
              if ($targetId) {
                  $db["admin_ids"] = array_values(array_filter($db["admin_ids"], fn($x) => (int)$x !== (int)$targetId));
                  db_save($db);
                  tg_sendMessage($chat, "๐๏ธ ฺฉุงุฑุจุฑ {$targetId} ุงุฒ ุงุฏููโูุง ุญุฐู ุดุฏ.");
              } else {
                  tg_sendMessage($chat, "โ๏ธ ุฑู ูพุงู ุดุฎุต ููุฑุฏูุธุฑ ุฑูพูุง ฺฉู ู ุฏูุจุงุฑู /removeadmin ุจุฒู.");
              }
              return;
          }
      }
      if (trim($text) === "/adminlist") {
        $ids = $db["admin_ids"] ?? [];
        if (empty($ids)) tg_sendMessage($chat, "ูฺ ุงุฏูู ุซุจุช ูุดุฏู.");
        else tg_sendMessage($chat, "ุงุฏููโูุง:\n" . implode("\n", array_map(fn($i) => "<code>".$i."</code>", $ids)));
        return;
      }
  }
  if (preg_match('~^/adminlogin\s+.*~', $text)) {
    $argPhone = normalize_phone($text);
    $ok = false;
    $cfg = $GLOBALS["ADMIN_PHONE"];
    if (is_array($cfg)) {
      foreach($cfg as $ph){ if ($argPhone === normalize_phone($ph)) { $ok = true; break; } }
    } else {
      $ok = ($argPhone === normalize_phone($cfg));
    }
    if ($ok) {
      if(!in_array((int)$fromId, $db["admin_ids"], true)){ $db["admin_ids"][] = (int)$fromId; db_save($db); }
      tg_sendMessage($chat, "โ ูุฑูุฏ ุงุฏูู ุชุฃุฏ ุดุฏ. ุญุงูุง ูโุชูุงู ุงุฒ ุฏุณุชูุฑ /panel ุงุณุชูุงุฏู ฺฉู.");
    } else {
      tg_sendMessage($chat, "โ ุดูุงุฑู ูุงุฑุฏุดุฏู ุจุง ุงุฏูู ุงุตู ููุฎูุงู ูุฏุงุฑุฏ.");
    }
    return;
  }
  
  $userForRegAndRestrict = &user($db, $chat); // For PV messages, chat and fromId are the same.
  
  // --- Mandatory Registration Flow ---
  if (!is_fully_registered($userForRegAndRestrict) && !$isSupportGroup) {
      if (strpos($text, "/start") === 0) {
          handle_registration_flow($userForRegAndRestrict, $chat, $text);
          db_save($db); return;
      }
      switch($userForRegAndRestrict["state"]) {
          case "collect_name":
              if ($text) {
                  $userForRegAndRestrict["name"] = $text;
                  handle_registration_flow($userForRegAndRestrict, $chat, $text);
              }
              db_save($db); return;
          case "await_phone":
              if (isset($update["message"]["contact"])) {
                  $userForRegAndRestrict["phone"] = normalize_phone($update["message"]["contact"]["phone_number"] ?? "");
                  tg_sendMessage($chat, "ุดูุงุฑู ุดูุง ุฐุฎุฑู ุดุฏ โ", rkb_remove());
                  handle_registration_flow($userForRegAndRestrict, $chat, $text);
              }
              db_save($db);
              return;
          case "collect_job_profile":
              if ($text) {
                  $userForRegAndRestrict["job"] = $text;
                  $userForRegAndRestrict["state"] = "idle";
                  $userName = htmlspecialchars($userForRegAndRestrict["name"]);
                  tg_sendMessage($chat, "ุนุงู ุดุฏ {$userName}! ุซุจุชโูุงู ุดูุง ุชฺฉูู ุดุฏ. โ\n\nุฎู ุฎูุดุญุงูู ฺฉู ุจู ุฌูุน ูุง ูพูุณุช. ุญุงูุง ูโุชูุงู ุงุฒ ุชูุงู ุงูฺฉุงูุงุช ุฑุจุงุช ุงุณุชูุงุฏู ฺฉู.", main_menu());
                  db_save($db); // Save after sending welcome
              }
              return;
          default:
              handle_registration_flow($userForRegAndRestrict, $chat, $text);
              db_save($db); return;
      }
  }
  
  // --- Standard User Flow (after registration) ---
  if (($userForRegAndRestrict["state"] ?? "") !== "support_await_msg") {
    if (enforce_restrictions($db, $userForRegAndRestrict, $chat, $isAdmin && $isSupportGroup)) { db_save($db); return; }
  }

  // --- REGULAR/ADMIN USER STATES (MUST BE CHECKED BEFORE ADMIN-ONLY INPUTS) ---
  $currentUser =& $userForRegAndRestrict;

  // Handle exercise submission
  if(preg_match("/^await_exercise_(\d+)_(\d+)$/", $currentUser["state"], $m)){
    $course_id = (int)$m[1];
    $step_index = (int)$m[2];
    $currentUser["state"] = "pending_exercise_{$course_id}_{$step_index}";
    tg_sendMessage($chat,"โ ุชูุฑู ุดูุง ุฏุฑุงูุช ุดุฏ. ุจู ูุญุถ ุชุงุฏ ุชูุณุท ูพุดุชุจุงูุ ูุฑุญูู ุจุนุฏ ุจุฑุงุชุงู ุจุงุฒ ูโุดูุฏ.");
    
    $mid = $update["message"]["message_id"];
    tg_forwardMessage($SUPPORT_CHAT, $chat, $mid);
    $db["pending_exercises"][] = ["user_id"=>$chat, "course_id"=>$course_id, "step"=>$step_index, "orig_mid"=>$mid, "time"=>time()];
    
    $humanStep = $step_index + 1;
    $course = get_course_by_id($db, $course_id);
    $course_title = $course['title'] ?? "ูุงูุดุฎุต";
    
    $info = "๐ <b>ุชุฃุฏ ุชูุฑู: {$course_title}</b> (ูุฑุญูู {$humanStep})\n"
          . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$chat}\">".$chat."</a>\n"
          . "ูุงู: ".($currentUser["name"]?:'-')." | ุดูุงุฑู: ".($currentUser["phone"]?:'-');
    tg_sendMessage($SUPPORT_CHAT, $info, admin_exercise_kb($chat, $course_id, $step_index));  
    db_save($db); return;
  }

  // Handle receipt submission
  if (preg_match("/^await_receipt_(\d+)$/", $currentUser["state"], $m)) {
      $course_id = (int)$m[1];
      $photoId = msg_get_photo_file_id($update["message"]);
      if (!$photoId) {
          tg_sendMessage($chat, "โ๏ธ ูุทูุงู ููุท <b>ุนฺฉุณ ุฑุณุฏ</b> ุฑุง ุจูุฑุณุชุฏ.", kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ุฏูุฑูโูุง","paid_courses")]]));
          return;
      }
      $currentUser["state"] = "pending_receipt_{$course_id}";

      $mid = $update["message"]["message_id"];
      tg_forwardMessage($SUPPORT_CHAT, $chat, $mid);
      $db["pending_receipts"][] = ["user_id" => $chat, "course_id" => $course_id, "file_id" => $photoId, "orig_mid" => $mid, "time" => time()];
      $course = get_course_by_id($db, $course_id);
      $course_title = $course['title'] ?? "ูุงูุดุฎุต";

      $info = "๐งพ <b>ุฑุณุฏ ุฌุฏุฏ ุจุฑุง ุฏูุฑู: {$course_title}</b>\n"
            . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$chat}\">".$chat."</a>\n"
            . "ูุงู: ".(($currentUser["name"]??'-')?:'-')." | ุดูุงุฑู: ".(($currentUser["phone"]??'-')?:'-');
      tg_sendMessage($SUPPORT_CHAT, $info, admin_receipt_kb($chat, $course_id));
      tg_sendMessage($chat, "ุฑุณุฏ ุดูุง ุฏุฑุงูุช ุดุฏ. ๐\nุชู ูพุดุชุจุงู ุจู ุฒูุฏ ุขู ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู ู ูุชุฌู ุฑุง ุจู ุดูุง ุงุทูุงุน ูโุฏูุฏ.");
      db_save($db); return;
  }

  // Handle VIP receipt submission
  if (strpos(($currentUser["state"] ?? ""), "vip_upload_receipt_") === 0) {
    $sub_type = substr($currentUser["state"], strlen("vip_upload_receipt_"));
    $photoId = msg_get_photo_file_id($update["message"]);
    if (!$photoId) {
      tg_sendMessage($chat, "โ๏ธ ูุทูุงู ููุท <b>ุนฺฉุณ ุฑุณุฏ</b> ุฑุง ุจูุฑุณุชุฏ.", kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช","back_to_menu")]]));
      return;
    }
    $currentUser["state"] = "await_vip_approval";
    db_save($db);
    $mid = $update["message"]["message_id"];
    tg_forwardMessage($SUPPORT_CHAT, $chat, $mid);
    
    $plan_map = ["3m"=>"ณ ูุงูู", "6m"=>"ถ ูุงูู", "12m"=>"ฑฒ ูุงูู"];
    $plan_text = $plan_map[$sub_type] ?? $sub_type;
    
    $info = "๐ <b>ุฑุณุฏ ุฌุฏุฏ ุงุดุชุฑุงฺฉ VIP</b>\n"
          . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$chat}\">".$chat."</a>\n"
          . "ูพูู ุงูุชุฎุงุจ: <b>{$plan_text}</b>\n"
          . "ูุงู: ".(($currentUser["name"]??'-')?:'-')." | ุดูุงุฑู: ".(($currentUser["phone"]??'-')?:'-');
    tg_sendMessage($SUPPORT_CHAT, $info, admin_vip_receipt_kb($chat, $sub_type));
    tg_sendMessage($chat, "ุฑุณุฏ ุดูุง ุฏุฑุงูุช ุดุฏ. ๐\nุชู ูพุดุชุจุงู ุจู ุฒูุฏ ุขู ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู ู ูุชุฌู ุฑุง ุจู ุดูุง ุงุทูุงุน ูโุฏูุฏ.");
    return;
  }

  // --- Admin Handlers (continued) ---
  if ($isAdmin) {
    $awaitVipCard = $db["await_set_vip_card"][$fromId] ?? false;
    if ($awaitVipCard) {
      $phId = msg_get_photo_file_id($update["message"]);
      if ($phId) {
        $db["vip_card"]["file_id"] = $phId;
        unset($db["await_set_vip_card"][$fromId]);
        db_save($db);
        tg_sendMessage($chat, "โ ุชุตูุฑ ฺฉุงุฑุช ุจุงูฺฉ ุจุง ููููุช ุฐุฎุฑู ุดุฏ.");
        return;
      } else {
        tg_sendMessage($chat, "โ๏ธ ูุทูุงู ฺฉ ุนฺฉุณ ุงุฑุณุงู ฺฉูุฏ.");
        return;
      }
    }
    $awaitStartMedia = $db["await_set_start_media"][$fromId] ?? false;
    if ($awaitStartMedia) {
        $mediaId = msg_get_any_media_file_id($update["message"], $mediaKind);
        if ($mediaId) {
            $db["start_media"]["file_id"] = $mediaId;
            $db["start_media"]["type"] = $mediaKind;
            unset($db["await_set_start_media"][$fromId]);
            db_save($db);
            tg_sendMessage($chat, "โ ุฑุณุงูู ุงุณุชุงุฑุช (ููุน: {$mediaKind}) ุฐุฎุฑู ุดุฏ.");
            return;
        } else {
            tg_sendMessage($chat, "โ๏ธ ูุทูุงู ฺฉ ฺฏู (animation)ุ ุนฺฉุณ ุง ูุฏุฆู ุงุฑุณุงู ฺฉูุฏ.");
            return;
        }
    }
    if (isset($db["pending_support_replies"][$fromId])) {
      $pending  = $db["pending_support_replies"][$fromId];
      $targetId = (int)$pending["user_id"];
      $mid      = $update["message"]["message_id"];
      $clean    = $text;
      
      $sentSomething = false;
      if ($text || isset($update["message"]["photo"]) || isset($update["message"]["video"]) || isset($update["message"]["document"])) {
          tg_sendMessage($targetId, "๐งโ๐ป <b>ูพุงุณุฎ ุงุฒ ุทุฑู ูพุดุชุจุงู:</b>");
          tg_copyMessage($targetId, $chat, $mid);
          $sentSomething = true;
      }

      if ($sentSomething) {
        tg_sendMessage($chat, "โ ูพุงุณุฎ ุดูุง ุจุฑุง ฺฉุงุฑุจุฑ {$targetId} ุงุฑุณุงู ุดุฏ.");
        unset($db["pending_support_replies"][$fromId]);
        support_open_close_user($db, $targetId);
        db_save($db);
        return;
      }
    }
    if (isset($db["pending_rejects"][$fromId])) {
      if ($text !== "") {
        $pending    = $db["pending_rejects"][$fromId];
        $targetUser = (int)$pending["user_id"];
        $courseId   = $pending["course_id"];
        $step       = $pending["step"];
        if (isset($db["users"][$targetUser])) {
          $uu =& user($db, $targetUser);
          $uu["state"] = "await_exercise_{$courseId}_{$step}";
          remove_pending_exercise($db, $targetUser, $courseId, $step);
          db_save($db);
          $hs  = $step + 1;
          tg_sendMessage($targetUser, "โ ูุชุงุณูุงูู ุชูุฑู ูุฑุญูู {$hs} ุดูุง ุฑุฏ ุดุฏ.\n\n๐ <b>ุฏูู:</b>\n".$text."\n\nูุทูุงู ุจุง ุชูุฌู ุจู ุงู ูฺฉุชูุ ุชูุฑู ุฎูุฏ ุฑุง ุฏูุจุงุฑู ุจูุฑุณุชุฏ.");
          tg_sendMessage($chat, "โ ูพุงู ุดูุง ุจุฑุง ฺฉุงุฑุจุฑ {$targetUser} ุงุฑุณุงู ุดุฏ.");
        } else {
          tg_sendMessage($chat, "โ๏ธ ฺฉุงุฑุจุฑ ูุฏู ุฏุฑ DB ูพุฏุง ูุดุฏ.");
        }
        unset($db["pending_rejects"][$fromId]);
        db_save($db);
        return;
      }
    }
    if (isset($db["pending_broadcast"]) && $db["pending_broadcast"]["admin_id"] == $fromId) {
        $db["pending_broadcast"]["message"] = $update["message"];
        $users_count = count($db["users"]);
        tg_sendMessage($chat, 
          "โ ูพุงู ุดูุง ุฏุฑุงูุช ุดุฏ. ุงู ูพุงู ุจุฑุง <b>{$users_count}</b> ฺฉุงุฑุจุฑ ุงุฑุณุงู ุฎูุงูุฏ ุดุฏ.\n\n" .
          "<b>ุขุง ุชุงุฏ ูโฺฉูุฏุ</b>",
          kb([[btn("โ ุจููุ ุงุฑุณุงู ฺฉู", "ap:broadcast_confirm"), btn("โ ููุ ูุบู ฺฉู", "ap:broadcast_cancel")]])
        );
        db_save($db);
        return;
    }
    if (isset($db["pending_admin_inputs"][$fromId])) {
      $cfg = $db["pending_admin_inputs"][$fromId];
      $mode = $cfg["mode"];
      if ($mode === "rename"){
          $uid = (int)$cfg["uid"];
          if ($text !== "") {
              if(isset($db["users"][$uid])){
                  $db["users"][$uid]["name"]=$text;
                  tg_sendMessage($chat,"โ ูุงู ฺฉุงุฑุจุฑ {$uid} ุจู ยซ{$text}ยป ุชุบุฑ ฺฉุฑุฏ.");
              } else {
                  tg_sendMessage($chat,"ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ.");
              }
              unset($db["pending_admin_inputs"][$fromId]); db_save($db);
              return;
          }
      }
      elseif ($mode === 'course_title' || $mode === 'edit_course_title') {
          $is_edit = $mode === 'edit_course_title';
          if ($is_edit) {
              $course_id = $cfg['course_id'];
              foreach ($db['courses'] as &$course) {
                  if ($course['id'] == $course_id) {
                      $course['title'] = $text;
                      break;
                  }
              }
              tg_sendMessage($chat, "โ ุนููุงู ุฏูุฑู ุจุง ููููุช ูุฑุงุด ุดุฏ.");
              unset($db["pending_admin_inputs"][$fromId]);
          } else {
              $db["pending_admin_inputs"][$fromId]['title'] = $text;
              $db["pending_admin_inputs"][$fromId]['mode'] = 'course_description';
              tg_sendMessage($chat, "โ ุนููุงู ุซุจุช ุดุฏ. ุญุงูุง <b>ุชูุถุญุงุช ุฏูุฑู</b> ุฑุง ุงุฑุณุงู ฺฉูุฏ.");
          }
          db_save($db);
          return;
      }
      elseif ($mode === 'course_description' || $mode === 'edit_course_description') {
          $is_edit = $mode === 'edit_course_description';
           if ($is_edit) {
              $course_id = $cfg['course_id'];
              foreach ($db['courses'] as &$course) {
                  if ($course['id'] == $course_id) {
                      $course['description'] = $text;
                      break;
                  }
              }
              tg_sendMessage($chat, "โ ุชูุถุญุงุช ุฏูุฑู ุจุง ููููุช ูุฑุงุด ุดุฏ.");
              unset($db["pending_admin_inputs"][$fromId]);
          } else {
              $db["pending_admin_inputs"][$fromId]['description'] = $text;
              $db["pending_admin_inputs"][$fromId]['mode'] = 'course_price';
              tg_sendMessage($chat, "โ ุชูุถุญุงุช ุซุจุช ุดุฏ. ุญุงูุง <b>ููุช ุฏูุฑู</b> ุฑุง ุจู ุชููุงู ู ุจู ุตูุฑุช ุนุฏุฏ ุงุฑุณุงู ฺฉูุฏ (ุจุฑุง ุฏูุฑู ุฑุงฺฏุงูุ 0 ุฑุง ุจูุฑุณุชุฏ).");
          }
          db_save($db);
          return;
      }
       elseif ($mode === 'course_price' || $mode === 'edit_course_price') {
          if (is_numeric($text)) {
              $is_edit = $mode === 'edit_course_price';
              if ($is_edit) {
                  $course_id = $cfg['course_id'];
                  foreach ($db['courses'] as &$course) {
                      if ($course['id'] == $course_id) {
                          $course['price'] = (int)$text;
                          break;
                      }
                  }
                  tg_sendMessage($chat, "โ ููุช ุฏูุฑู ุจุง ููููุช ูุฑุงุด ุดุฏ.");
                  unset($db["pending_admin_inputs"][$fromId]);
              } else {
                  $db["pending_admin_inputs"][$fromId]['price'] = (int)$text;
                  $db["pending_admin_inputs"][$fromId]['mode'] = 'course_content';
                  $db["pending_admin_inputs"][$fromId]['content'] = [];
                   tg_sendMessage($chat, "โ ููุช ุซุจุช ุดุฏ. ุญุงูุง ูุญุชูุง ุฏูุฑู ุฑุง ูุฑุญูู ุจู ูุฑุญูู (ูุฏุฆู ุง ุนฺฉุณ) ููุฑูุงุฑุฏ ฺฉูุฏ. ฺฉูพุดู ูุฑ ูพุงูุ ูุชู ููุงู ูุฑุญูู ุฎูุงูุฏ ุจูุฏ.\n\n<b>ููู:</b> ุจุฑุง ุฏูุฑู ุฑุงฺฏุงูุ ุฏุฑ ฺฉูพุดู ูุฑ ูุฑุญููุ ูุชู ุชูุฑู ุฑุง ูุฒ ุจุง ูุฑูุช ุฒุฑ ุงุถุงูู ฺฉูุฏ:\n<code>[EXERCISE]ูุชู ฺฉุงูู ุชูุฑู ุงูุฌุง[/EXERCISE]</code>\n\nูพุณ ุงุฒ ุงุฑุณุงู ุชูุงู ูุฑุงุญูุ ุฏุณุชูุฑ /done ุฑุง ุจูุฑุณุชุฏ.");
              }
              db_save($db);
          } else {
              tg_sendMessage($chat, "โ๏ธ ูุทูุงู ููุช ุฑุง ููุท ุจู ุตูุฑุช ุนุฏุฏ (ูุซูุงู: 150000) ูุงุฑุฏ ฺฉูุฏ.");
          }
          return;
      }
      elseif ($mode === 'course_content' || $mode === 'add_course_step') {
          if ($text === '/done') {
              if ($mode === 'add_course_step') {
                 tg_sendMessage($chat, "โ ูุฑุงุญู ุฌุฏุฏ ุจุง ููููุช ุจู ุฏูุฑู ุงุถุงูู ุดุฏูุฏ.");
              } else {
                  $course_data = $db["pending_admin_inputs"][$fromId];
                  if (empty($course_data['content'])) {
                      tg_sendMessage($chat, "โ๏ธ ูฺ ูุญุชูุง ุจุฑุง ุฏูุฑู ุงุฑุณุงู ูุดุฏ. ุนููุงุช ูุบู ุดุฏ.");
                      unset($db["pending_admin_inputs"][$fromId]); db_save($db);
                      return;
                  }
                  
                  $new_course_id = count($db['courses']) > 0 ? max(array_column($db['courses'], 'id')) + 1 : 1;
                  
                  $db['courses'][] = [
                      "id" => $new_course_id,
                      "title" => $course_data['title'],
                      "description" => $course_data['description'],
                      "price" => $course_data['price'],
                      "content" => $course_data['content']
                  ];
                   tg_sendMessage($chat, "โ ุฏูุฑู ุฌุฏุฏ ุจุง ุนููุงู ยซ{$course_data['title']}ยป ุจุง ููููุช ุณุงุฎุชู ุดุฏ.");
              }
              unset($db["pending_admin_inputs"][$fromId]);
              db_save($db);
              return;
          }

          $file_id = msg_get_any_media_file_id($update["message"], $type);
          if ($file_id) {
              $caption_text = $update['message']['caption'] ?? '';
              $exercise_prompt = null;
              
              $price = ($mode === 'add_course_step') ? get_course_by_id($db, $cfg['course_id'])['price'] : $cfg['price'];

              if ($price == 0 && preg_match('/\[EXERCISE\](.*?)\[\/EXERCISE\]/s', $caption_text, $matches)) {
                  $exercise_prompt = trim($matches[1]);
                  $caption_text = trim(str_replace($matches[0], '', $caption_text));
              }
              
              $new_step_data = ["type" => $type, "file_id" => $file_id, "caption" => $caption_text, "exercise_prompt" => $exercise_prompt];

              if ($mode === 'add_course_step') {
                  $course_id = $cfg['course_id'];
                  foreach ($db['courses'] as &$course) {
                      if ($course['id'] == $course_id) {
                          $course['content'][] = $new_step_data;
                          tg_sendMessage($chat, "ูุฑุญูู " . count($course['content']) . " ุงุถุงูู ุดุฏ. ูุฑุญูู ุจุนุฏ ุฑุง ุจูุฑุณุชุฏ ุง /done ุฑุง ุจุฒูุฏ.");
                          break;
                      }
                  }
              } else {
                   $db["pending_admin_inputs"][$fromId]['content'][] = $new_step_data;
                   tg_sendMessage($chat, "ูุฑุญูู " . count($db["pending_admin_inputs"][$fromId]['content']) . " ุงุถุงูู ุดุฏ. ูุฑุญูู ุจุนุฏ ุฑุง ุจูุฑุณุชุฏ ุง /done ุฑุง ุจุฒูุฏ.");
              }
              
              db_save($db);
          } else {
              tg_sendMessage($chat, "โ๏ธ ูุทูุงู ฺฉ ูุฏุฆู ุง ุนฺฉุณ ุงุฑุณุงู ฺฉูุฏ. ุจุฑุง ูพุงุงู /done ุฑุง ุจุฒูุฏ.");
          }
          return;
      }
    }
  }

  // --- Regular Message Handlers ---
  // Note: user context for non-admins is $currentUser which was set earlier
  
  if (preg_match('~^/start(?: ref_(\d+))?$~', $text, $matches)){
    if (isset($matches[1])) {
        $referrer_id = (int)$matches[1];
        if (empty($currentUser['referrer_id']) && $referrer_id != $chat) {
            $currentUser['referrer_id'] = $referrer_id;
        }
    }
    $currentUser["state"] = "idle";
    $media = $db["start_media"] ?? null;
    if ($media && !empty($media["file_id"])) {
        if ($media['type'] === 'animation') tg_sendAnimation($chat, $media['file_id']);
        elseif ($media['type'] === 'video' || $media['type'] === 'document') tg_sendVideo($chat, $media['file_id'], null);
        elseif ($media['type'] === 'photo') tg_sendPhoto($chat, $media['file_id'], null);
    }
    tg_sendMessage($chat, welcome_text(), main_menu());
    db_save($db); return;
  }
  if ($text==="/about"){
    tg_sendMessage($chat, about_text(), kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช","back_to_menu")]]));
    return;
  }
  if (preg_match('~^/?(back|cancel)/?$~i',$text)) {
    $currentUser["state"]="idle"; db_save($db);
    tg_sendMessage($chat, "โ ุจู ููู ุงุตู ุจุฑฺฏุดุช.", rkb_remove());
    tg_sendMessage($chat, welcome_text(), main_menu()); return;
  }

    // Business Automation Flow
    if (strpos($currentUser['state'], 'biz_auto_') === 0) {
        $current_question_num = (int) substr($currentUser['state'], 9);
        $currentUser['biz_auto_form_data']['q' . $current_question_num] = $text;

        $next_question_num = $current_question_num + 1;
        $questions = [
            2 => "ฒ/ต: ุนุงู! ุญุงูุง ุจฺฏู <b>ูุดุชุฑโูุง ุงุตู</b> ุดูุง ฺู ฺฉุณุงู ูุณุชูุฏุ (ูุซูุงู: ุฎุงููโูุง ุฎุงููโุฏุงุฑุ ุฏุงูุดุฌููุงุ ูุฏุฑุงู ุดุฑฺฉุชโูุง ู...)",
            3 => "ณ/ต: ุฏุฑ ุญุงู ุญุงุถุฑ <b>ุจุฒุฑฺฏโุชุฑู ฺุงูุด</b> ุดูุง ุฏุฑ ูุฑูุด ุง ุจุงุฒุงุฑุงุจ ฺุณุชุ (ูุซูุงู: ูพุฏุง ฺฉุฑุฏู ูุดุชุฑ ุฌุฏุฏุ ูพุงุณุฎฺฏู ุจู ูุดุชุฑโูุงุ ุชููุฏ ูุญุชูุง ู...)",
            4 => "ด/ต: ูุทูุงู ุขุฏุฑุณ <b>ุณุงุชุ ฺฉุงูุงู ุชูฺฏุฑุงู ุง ูพุฌ ุงูุณุชุงฺฏุฑุงู</b> ุฎูุฏ ุฑุง ุจูุฑุณุชุฏ.",
            5 => "ต/ต: ู ุฏุฑ ุขุฎุฑุ ุจุฑุง ููุงููฺฏ ฺฉ ุฌูุณู ูุดุงูุฑู ุฑุงฺฏุงูุ ูุทูุงู <b>ูุงู ฺฉุงูู ู ุดูุงุฑู ุชูุงุณ</b> ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ."
        ];

        if (isset($questions[$next_question_num])) {
            $currentUser['state'] = 'biz_auto_q' . $next_question_num;
            tg_sendMessage($chat, $questions[$next_question_num]);
        } else {
            // End of questionnaire
            $answers = $currentUser['biz_auto_form_data'];
            $req_id = uniqid('biz_');
            $summary = "๐ก <b>ุฏุฑุฎูุงุณุช ุฌุฏุฏ ุจุฑุง ููุดููุฏุณุงุฒ ฺฉุณุจโูฺฉุงุฑ</b>\n\n"
                       . "๐ค ฺฉุงุฑุจุฑ: <a href='tg://user?id={$chat}'>{$chat}</a>\n"
                       . "<b>ูุงู ุซุจุชโุดุฏู:</b> " . ($currentUser['name'] ?? 'ุซุจุช ูุดุฏู') . "\n"
                       . "<b>ุดูุงุฑู ุซุจุชโุดุฏู:</b> " . ($currentUser['phone'] ?? 'ุซุจุช ูุดุฏู') . "\n\n"
                       . "<b>ฑ. ุฒููู ูุนุงูุช:</b>\n" . ($answers['q1'] ?? 'โ') . "\n\n"
                       . "<b>ฒ. ูุดุชุฑุงู ูุฏู:</b>\n" . ($answers['q2'] ?? 'โ') . "\n\n"
                       . "<b>ณ. ุจุฒุฑฺฏโุชุฑู ฺุงูุด:</b>\n" . ($answers['q3'] ?? 'โ') . "\n\n"
                       . "<b>ด. ุขุฏุฑุณโูุง:</b>\n" . ($answers['q4'] ?? 'โ') . "\n\n"
                       . "<b>ต. ุงุทูุงุนุงุช ุชูุงุณ ุจุฑุง ูุดุงูุฑู:</b>\n" . ($answers['q5'] ?? 'โ') . "\n\n"
                       . "#ููุดููุฏุณุงุฒ #{$req_id}";
            
            tg_sendMessage($SUPPORT_CHAT, $summary);
            
            $db['business_automation_requests'][] = [
                'id' => $req_id,
                'user_id' => $chat,
                'data' => $answers,
                'time' => time(),
                'status' => 'pending'
            ];

            $currentUser['state'] = 'idle';
            $currentUser['biz_auto_form_data'] = []; // Clear temporary data
            
            $confirmation_text = "ุฏุฑุฎูุงุณุช ุดูุง ุจุง ููููุช ุซุจุช ุดุฏ.\n\n"
                               . "ุชู ูุง ุงุทูุงุนุงุช ุดูุง ุฑุง ุจุฑุฑุณ ฺฉุฑุฏู ู ุจู ุฒูุฏ ุจุฑุง ููุงููฺฏ ุฌูุณู ูุดุงูุฑู ุจุง ุดูุง ุชูุงุณ ูโฺฏุฑุฏ.\n\n"
                               . "<b>ุงุฏุขูุฑ ูุฒููโูุง:</b>\n"
                               . "โซ๏ธ ูุฒูู ุงุดุชุฑุงฺฉ ูุงูุงูู: <b>นทฐ ูุฒุงุฑ ุชููุงู</b>\n"
                               . "โซ๏ธ ูุฒูู ูุตุจ ู ุฑุงูโุงูุฏุงุฒ ุงููู: <b>ตฐฐ ูุฒุงุฑ ุชููุงู</b>";

            tg_sendMessage($chat, $confirmation_text, main_menu());
        }
        db_save($db); return;
    }


  if (($currentUser["state"] ?? "") === "support_await_msg") {
    if ($text === "โฌ๏ธ ุจุงุฒฺฏุดุช") {
      $currentUser["state"] = "idle";
      db_save($db);
      tg_sendMessage($chat, "โ ุจู ููู ุงุตู ุจุฑฺฏุดุช.", rkb_remove());
      tg_sendMessage($chat, welcome_text(), main_menu()); return;
    }
    $mid = $update["message"]["message_id"];
    tg_forwardMessage($SUPPORT_CHAT, $chat, $mid);
    $preview = ""; $caption = trim($update["message"]["caption"] ?? "");
    if ($text !== "") { $preview = $text; } elseif ($caption !== "") { $preview = $caption; }
    $mediaLabel = "";
    if (isset($update["message"]["photo"]))   $mediaLabel = "๐ท ุนฺฉุณ";
    elseif (isset($update["message"]["video"]))   $mediaLabel = "๐ฌ ูุฏุฆู";
    elseif (isset($update["message"]["document"]))$mediaLabel = "๐ ูุงู";
    elseif (isset($update["message"]["voice"]))   $mediaLabel = "๐ค ูุณ";
    elseif (isset($update["message"]["audio"]))   $mediaLabel = "๐ต ุตุฏุง";
    elseif (isset($update["message"]["sticker"])) $mediaLabel = "๐งฉ ุงุณุชฺฉุฑ";
    elseif (isset($update["message"]["animation"])) $mediaLabel = "๐ ุงููุดู";
    if ($mediaLabel !== "") { $preview = trim($mediaLabel.( $preview!=="" ? ": ".$preview : "" )); }
    if ($preview==="") $preview="โ";
    $preview = preg_replace('/\s+/u',' ', $preview);
    support_open_upsert($db, $chat, $mid, $preview);
    $info = "๐ <b>ุฏุฑุฎูุงุณุช ูพุดุชุจุงู ุฌุฏุฏ</b>\n"
          . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$chat}\">".$chat."</a>\n"
          . "ูุงู: ".(($currentUser["name"]??'-')?:'-')." | ุดูุงุฑู: ".(($currentUser["phone"]??'-')?:'-');
    tg_sendMessage($SUPPORT_CHAT, $info, admin_support_kb($chat));
    tg_sendMessage($chat, "โ ูพุงู ุดูุง ุจู ุฏุณุช ุชู ูพุดุชุจุงู ุฑุณุฏ. ูุทูุงู ุตุจูุฑ ุจุงุดุฏุ ุจู ุฒูุฏ ูพุงุณุฎ ุดูุง ุฑุง ูููุฌุง ุงุฑุณุงู ูโฺฉูู.");
    $currentUser["state"]="idle"; db_save($db); return;
  }

  // Default fallback
  if(!$isSupportGroup) {
    tg_sendMessage($chat, "ุฏุณุชูุฑ ุดูุง ุฑุง ูุชูุฌู ูุดุฏู. ุจุฑุง ุดุฑูุน /start ุฑุง ุจุฒูุฏ ุง ุงุฒ ุฏฺฉููโูุง ููู ุงุตู ุงุณุชูุงุฏู ฺฉูุฏ.", main_menu());
  }
  db_save($db); return;
}
/* ==== MSG_HANDLER END ============================================ */

/* ==== CB_HANDLER START =========================================== */
if(isset($update["callback_query"])){
  $db      = db_load();
  add_missing_courses_if_needed($db); // Ensure default courses exist
  $cb      = $update["callback_query"];
  $chat    = $cb["message"]["chat"]["id"];
  $fromId  = $cb["from"]["id"] ?? null;
  $data    = $cb["data"];
  $msgId   = $cb["message"]["message_id"];
  $isAdmin = is_admin($db, $fromId);
  $isSupportGroup = (string)$chat === (string)$SUPPORT_CHAT;
  
  $u =& user($db, $fromId); // User context is always the person who clicked
  $userForRegAndRestrict = &user($db, $chat); // For PV context, chat and fromId are same

  // --- Mandatory Registration check for callbacks ---
  if (!is_fully_registered($userForRegAndRestrict) && strpos($data, "ai_lvl:") !== 0 && !$isSupportGroup) {
      handle_registration_flow($userForRegAndRestrict, $chat, null);
      db_save($db);
      tg_answerCb($cb["id"]);
      return;
  }
   if (($userForRegAndRestrict["state"] ?? "") === "await_ai" && strpos($data, "ai_lvl:") === 0) {
       $val = substr($data, 7);
       $userForRegAndRestrict["ai"] = $val;
       tg_answerCb($cb["id"], "ุณุทุญ ุขุดูุง ุดูุง ุซุจุช ุดุฏ โ");
       tg_editMessageText($chat, $msgId, "ููููู! ุณุทุญ ุขุดูุง ุดูุง ุซุจุช ุดุฏ."); // Remove the button after click
       handle_registration_flow($userForRegAndRestrict, $chat, null);
       db_save($db);
       return;
   }

  $skipLockCb = in_array($data, ["support_contact"]);
  if (!$skipLockCb){
    if (enforce_restrictions($db, $userForRegAndRestrict, $chat, $isAdmin && $isSupportGroup)) { tg_answerCb($cb["id"]); db_save($db); return; }
  }

  if ($data === "back_to_menu") {
    $userForRegAndRestrict["state"]="idle"; db_save($db);
    tg_editMessageText($chat, $msgId, welcome_text(), main_menu()); tg_answerCb($cb["id"]); return;
  }

  if ($data === "toolkit") { tg_editMessageText($chat, $msgId, "๐งฐ <b>ุงุจุฒุงุฑฺฉ ATB</b>\nุงูุฌุง ฺฉ ุณุฑ ููฺฉ ฺฉุงุฑุจุฑุฏ ุจุฑุง ุดูุง ุขูุงุฏู ฺฉุฑุฏูโุงู:", toolkit_kb()); tg_answerCb($cb["id"]); return; }
  if ($data === "toolkit_ctfc") { sendCTFC($chat); tg_answerCb($cb["id"]); return; }
  if ($data === "toolkit_vpn") {
    $vpnTxt = "๐ก <b>ุงฺฉุงูุช ูพุฑููู ExpressVPN (ฺฉโุณุงูู)</b>\n\n"
            . "ุงู ุงฺฉุงูุชโูุง ุจุง ููุช ุนุงู ุชูู ุดุฏูโุงูุฏ ุชุง ุจุฏูู ุฏุบุฏุบู ู ุจุง ุจุงูุงุชุฑู ุณุฑุนุช ุจู ุฏูุง ููุด ูุตููุน ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดุฏ.\n\n"
            . "๐ ููุช ูฺู ุงุนุถุง ฺฉูุงุจ: <b>590 ูุฒุงุฑ ุชููุงู</b> (ตฐูช ุชุฎูู)\n"
            . "โ ุจุฏูู ูุทุน โ ูู ุจุฑุง ููุจุงู ู ูู ุจุฑุง ุฏุณฺฉุชุงูพ\n\n"
            . "๐ <b>ุจุฑุง ุฎุฑุฏ ุจู ุงู ุขุฏ ูพุงู ุฏูุฏ:</b> @ExpVpn_Admin\n\n"
            . "<i>(ุชูุฌู: ูุง ููุท ุงู ูุฑูุดูุฏู ูุนุชุจุฑ ุฑุง ุจู ุดูุง ูุนุฑู ูโฺฉูู.)</i>";
    tg_editMessageText($chat, $msgId, $vpnTxt, kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ุงุจุฒุงุฑฺฉ","toolkit")]]));
    tg_answerCb($cb["id"]); return;
  }

  if ($data === "faq") {
    tg_editMessageText($chat, $msgId, "โ <b>ุณูุงูุงุช ูุชุฏุงูู</b>\nุฌูุงุจ ุณูุงู ุดูุง ุงุญุชูุงูุงู ุงูุฌุงุณุช. ุฑู ฺฉ ุงุฒ ฺฏุฒููโูุง ุจุฒูุฏ:", faq_menu_kb());
    tg_answerCb($cb["id"]); return;
  }
  if (strpos($data,"faq:")===0) {
    $k = substr($data,4); $items = faq_items();
    if (isset($items[$k])) {
      $ans = "<b>".$items[$k]["q"]."</b>\n\n".$items[$k]["a"];
      $kb = kb([
        [ ["text"=>"๐ ูุดุงูุฏู ุจูู ุณูุงูุงุช","callback_data"=>"faq"] ],
        [ ["text"=>"โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","callback_data"=>"back_to_menu"] ]
      ]);
      tg_editMessageText($chat, $msgId, $ans, $kb);
    }
    tg_answerCb($cb["id"]); return;
  }
  
  if($data === "start_free_course"){
    $progress = get_user_course_progress($db, $chat, 1);
    $next_step = ($progress['progress'] ?? -1) + 1;
    $free_course = get_course_by_id($db, 1);
    if ($next_step < count($free_course['content'])) {
        send_course_step($db, $chat, 1, $next_step);
    } else {
        $userForRegAndRestrict["state"]="completed_free";
        $finalText = "ุชุจุฑฺฉ! ุดูุง ูุจูุงู ุฏูุฑู ููุฏูุงุช ุฑุง ุจุง ููููุช ุชูุงู ฺฉุฑุฏูโุงุฏ.\n\n"
                   . "ุจู ููู ุฏููุ ุดูุง ุนุถู ฺฉุงูุงู ุฎุตูุต <b>ATB Club</b> ูุณุชุฏ. ุฑู ุฏฺฉูู ุฒุฑ ุจุฒูุฏ ู ูุงุฑุฏ ุดูุฏ:";
        $finalKb = json_encode(["inline_keyboard" => [[["text" => "๐ช ูุฑูุฏ ุจู ฺฉูุงุจ ATB", "url" => $GLOBALS["PRIVATE_CHANNEL_INVITE"]]]]], JSON_UNESCAPED_UNICODE);
        tg_sendMessage($chat, $finalText, $finalKb);
    }
    db_save($db); tg_answerCb($cb["id"]); return;
  }

  if ($data === "about") {
    tg_editMessageText($chat, $msgId, about_text(), kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช","back_to_menu")]]));
    tg_answerCb($cb["id"]); return;
  }

  if ($data === "account_menu") {
    $ref_balance = ($userForRegAndRestrict['referral_balance_usd'] ?? 0);
    $progress = get_user_course_progress($db, $chat, 1);
    $p_step = ($progress['progress'] ?? -1) + 1;
    $p_total = count(get_course_by_id($db, 1)['content'] ?? []);
    $p_text = ($p_step >= $p_total) ? "ุชฺฉูู ุดุฏู โ" : "ูุฑุญูู {$p_step} ุงุฒ {$p_total}";
    
    $sub_status = format_sub_status($db, $chat);

    $courses_info = [];
    if(isset($db['user_courses'][$chat])){
        foreach($db['user_courses'][$chat] as $cid => $cdata){
            if($cid == 1) continue;
            $course = get_course_by_id($db, $cid);
            $title = $course['title'] ?? "ุฏูุฑู {$cid}";
            $courses_info[] = "โข {$title} ({$cdata['status']})";
        }
    }
    $courses_text = empty($courses_info) ? "ูุฏุงุฑุฏ" : "\n" . implode("\n", $courses_info);
    $msg  = "๐ค <b>ูพุฑููุงู ฺฉุงุฑุจุฑ ุดูุง</b>\n\n"
          ."<b>- ูุงู:</b> ".($userForRegAndRestrict["name"]??"-")."\n"
          ."<b>- ุดูุงุฑู:</b> ".($userForRegAndRestrict["phone"]??"-")."\n"
          ."<b>- ุดุบู:</b> ".($userForRegAndRestrict["job"]??"-")."\n"
          ."<b>- ุณุทุญ ุขุดูุง ุจุง AI:</b> ".($userForRegAndRestrict["ai"]??"-")."\n\n"
          ."๐ <b>ุงุดุชุฑุงฺฉ VIP:</b> {$sub_status}\n"
          ."๐ <b>ูุถุนุช ุฏูุฑู ููุฏูุงุช:</b> {$p_text}\n"
          ."๐ฐ <b>ุฏูุฑูโูุง ุฎุฑุฏุงุฑ ุดุฏู:</b> {$courses_text}\n\n"
          ."๐ต <b>ุฏุฑุขูุฏ ุดูุง ุงุฒ ุฏุนูุช ุฏูุณุชุงู:</b> {$ref_balance} ุฏูุงุฑ";
    tg_editMessageText($chat, $msgId, $msg, kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","back_to_menu")]]));
    tg_answerCb($cb["id"]); return;
  }

  if ($data === "referral_menu") {
      global $BOT_TOKEN, $REFERRAL_REWARD_TEXT;
      $bot_username = "YourBotUsername"; // Fallback
      $me = tg_request("getMe", []);
      if ($me && $me['ok']) {
          $bot_username = $me['result']['username'];
      }
      $ref_link = "https://t.me/{$bot_username}?start=ref_{$chat}";
      $ref_balance = ($userForRegAndRestrict['referral_balance_usd'] ?? 0);

      $msg = "๐ต <b>ฺฉุณุจ ุฏุฑุขูุฏ ุฏูุงุฑ ุจุง ุฏุนูุช ุงุฒ ุฏูุณุชุงู!</b>\n\n"
           . "ุจุง ูุนุฑู ุฑุจุงุช ATB ุจู ุฏูุณุชุงู ุฎูุฏุ ุจู ุฑุงุญุช ุฏุฑุขูุฏ ุฏูุงุฑ ุฏุงุดุชู ุจุงุดุฏ.\n\n"
           . "<b>ฺุทูุฑ ฺฉุงุฑ ูโฺฉูุฏุ</b>\n"
           . "ฑ. ููฺฉ ุงุฎุชุตุงุต ุฒุฑ ุฑุง ุจุฑุง ุฏูุณุชุงู ุฎูุฏ ุจูุฑุณุชุฏ.\n"
           . "ฒ. ุจู ุงุฒุง ูุฑ ุฏูุณุช ฺฉู ุจุง ููฺฉ ุดูุง ูุงุฑุฏ ุฑุจุงุช ุดูุฏ ู <b>ุฏูุฑู ููุฏูุงุช ุฑุงฺฏุงู ุฑุง ฺฉุงูู ฺฉูุฏ</b>ุ ูุจูุบ <b>{$REFERRAL_REWARD_TEXT}</b> ุจู ฺฉู ูพูู ุดูุง ุงุถุงูู ูโุดูุฏ.\n\n"
           . "<b>ููฺฉ ุฏุนูุช ุดูุง:</b>\n"
           . "<code>{$ref_link}</code>\n\n"
           . "<b>ููุฌูุฏ ูุนู ุดูุง:</b> {$ref_balance} ุฏูุงุฑ\n\n"
           . "<i>ุจุฑุง ุชุณูู ุญุณุงุจุ ฺฉุงู ุงุณุช ุจู ูพุดุชุจุงู ูพุงู ุฏูุฏ.</i>";

      tg_editMessageText($chat, $msgId, $msg, kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู","back_to_menu")]]));
      tg_answerCb($cb["id"]); return;
  }

  if (strpos($data, "seen_step:") === 0) {
    list(, $course_id, $step_index) = explode(":", $data);
    $course_id = (int)$course_id;
    $step_index = (int)$step_index;

    if (user_is_locked($userForRegAndRestrict) || user_is_banned($userForRegAndRestrict)){ tg_answerCb($cb["id"], "ูุชุงุณูุงูู ุฏุณุชุฑุณ ุดูุง ูุญุฏูุฏ ุงุณุช."); return; }
    
    $needState = "watch_{$course_id}_{$step_index}";
    $wat = (int)($userForRegAndRestrict["watch_started_at"] ?? 0);
    $elapsed = ($wat > 0) ? (time() - $wat) : 0;
    if (($userForRegAndRestrict["state"] ?? "") === $needState && $elapsed < MIN_WATCH_SECONDS) {
      tg_answerCb($cb["id"], "ูููุฒ ุฒูุฏ ุงุณุช! ูุทูุงู ุงูู ูุฏุฆู ุฑุง ฺฉุงูู ุจุจูุฏ.");
      return;
    }
    
    $course = get_course_by_id($db, $course_id);
    if(!$course) return;
    if ($course['price'] == 0 && isset($course['content'][$step_index]['exercise_prompt'])) {
        $userForRegAndRestrict["state"] = "await_exercise_{$course_id}_{$step_index}";
        db_save($db);
        tg_sendMessage($chat, $course['content'][$step_index]['exercise_prompt']);
    } else {
        if (!isset($db['user_courses'][$chat][$course_id])) $db['user_courses'][$chat][$course_id] = ['status'=>'active', 'progress'=>-1];
        $db['user_courses'][$chat][$course_id]['progress'] = $step_index;
        
        $next_step = $step_index + 1;
        if ($next_step < count($course['content'])) {
            send_course_step($db, $chat, $course_id, $next_step);
        } else {
            $db['user_courses'][$chat][$course_id]['status'] = 'completed';
            $userForRegAndRestrict['state'] = 'idle';
            db_save($db);
            tg_sendMessage($chat, "ุชุจุฑฺฉ! ุดูุง ุฏูุฑู ยซ{$course['title']}ยป ุฑุง ุจุง ููููุช ุจู ูพุงุงู ุฑุณุงูุฏุฏ.", main_menu());
        }
    }
    tg_answerCb($cb["id"], "ุนุงูู! โ");
    return;
  }
  
  if ($data === "vip_membership") {
    $pr = "๐ <b>ูพุดููุงุฏ ูฺูโ ุงุดุชุฑุงฺฉ VIP</b>\n\n"
        . "ูโุฎูุงูุฏ ฺฉ ูุฏู ุฌููุชุฑ ุงุฒ ุจูู ุจุงุดุฏ ู ุงุฒ ููุด ูุตููุน ุจุฑุง ุฑุดุฏ ฺฉุณุจโูฺฉุงุฑุชุงู ูพูู ุจุณุงุฒุฏุ ุนุถูุช VIP ุจุฑุง ุดูุงุณุช!\n\n"
        . "<b>ุฏุฑ ฺฉุงูุงู VIP ฺู ฺุฒ ููุชุธุฑ ุดูุงุณุชุ</b>\n"
        . "โซ๏ธ <b>ุขููุฒุดโูุง ููุชฺฏ:</b> ุฌุฏุฏุชุฑู ู ฺฉุงุฑุจุฑุฏโุชุฑู ุชฺฉูฺฉโูุง AI ฺฉู ูุณุชููุงู ุฑู ุฏุฑุขูุฏ ุดูุง ุชุฃุซุฑ ูโฺฏุฐุงุฑุฏ.\n"
        . "โซ๏ธ <b>ูพุฑุงููพุชโูุง ุขูุงุฏู:</b> ฺฉุชุงุจุฎุงููโุง ุงุฒ ุฏุณุชูุฑุงุช ุญุฑููโุง ุจุฑุง ุชููุฏ ูุญุชูุง, ุจุงุฒุงุฑุงุจ ู ูุฑูุด.\n"
        . "โซ๏ธ <b>ูพุดุชุจุงู ุงุฎุชุตุงุต:</b> ุณูุงูุงุช ุฎูุฏ ุฑุง ุจูพุฑุณุฏ ู ุงุฒ ุชู ูุง ุฑุงูููุง ุชุฎุตุต ุจฺฏุฑุฏ.\n\n"
        . "๐ <b>ูุฏู ูฺู:</b> ุจุง ุฎุฑุฏ ูุฑ ฺฉุฏุงู ุงุฒ ุงุดุชุฑุงฺฉโูุงุ ฺฉ <b>ุงฺฉุงูุช ฺฉโุณุงูู ExpressVPN</b> ุจู ุงุฑุฒุด ตนฐ ูุฒุงุฑ ุชููุงู ูุฏู ุจฺฏุฑุฏ!\n\n"
        . "<b>ูพููโูุง ุงุดุชุฑุงฺฉ:</b>\n"
        . "โซ๏ธ ณ ูุงูู: <b>ณนฐ ูุฒุงุฑ ุชููุงู</b>\n"
        . "โซ๏ธ ถ ูุงูู: <b>ดนฐ ูุฒุงุฑ ุชููุงู</b> (ูพุฑุทุฑูุฏุงุฑุชุฑู)\n"
        . "โซ๏ธ ฑฒ ูุงูู: <b>นทฐ ูุฒุงุฑ ุชููุงู</b>\n\n"
        . "ุจุฑุง ูพุฑุฏุงุฎุชุ ูุจูุบ ูพูู ุฏูุฎูุงู ุฎูุฏ ุฑุง ุจู ุดูุงุฑู ฺฉุงุฑุช ููุฌูุฏ ุฏุฑ ุงู ุชุตูุฑ ูุงุฑุฒ ฺฉูุฏ ู ุจุนุฏ ุฑู ุฏฺฉูู ูุฑุจูุท ุจู ูพูู ุฎูุฏ ุจุฒูุฏ ุชุง ุฑุณุฏ ุฑุง ุงุฑุณุงู ฺฉูุฏ.";
        
    $rows = [
        [btn("ุงุฑุณุงู ุฑุณุฏ (ูพูู ณ ูุงูู)", "vip_send_receipt:3m")],
        [btn("ุงุฑุณุงู ุฑุณุฏ (ูพูู ถ ูุงูู)", "vip_send_receipt:6m")],
        [btn("ุงุฑุณุงู ุฑุณุฏ (ูพูู ฑฒ ูุงูู)", "vip_send_receipt:12m")],
        [btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู", "back_to_menu")]
    ];

    $card_file_id = $db["vip_card"]["file_id"] ?? null;
    if ($card_file_id) {
        tg_sendPhoto($chat, $card_file_id, $pr, json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE));
    } else {
        $pr .= "\n\nโน๏ธ <i>ุดูุงุฑู ฺฉุงุฑุช ุชูุณุท ุงุฏูู ุชูุธู ูุดุฏู ุงุณุช. ูุทูุงู ุจู ูพุดุชุจุงู ูพุงู ุฏูุฏ.</i>";
        tg_sendMessage($chat, $pr, json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE));
    }
    tg_answerCb($cb["id"]);
    return;
  }
  
  if (strpos($data, "vip_send_receipt:") === 0) {
    $sub_type = substr($data, strlen("vip_send_receipt:"));
    $userForRegAndRestrict["state"] = "vip_upload_receipt_" . $sub_type; 
    db_save($db);
    tg_sendMessage($chat, "๐ธ ูุทูุงู <b>ููุท ุนฺฉุณ ุฑุณุฏ ูพุฑุฏุงุฎุช ุฎูุฏ ุฑุง</b> ุงูุฌุง ุจูุฑุณุชุฏ.", kb([[btn("โฌ๏ธ ุงูุตุฑุงู ู ุจุงุฒฺฏุดุช","back_to_menu")]]));
    tg_answerCb($cb["id"]);
    return;
  }
  
    // New Feature: Business Automation Start
    if ($data === "biz_automation_start") {
        $userForRegAndRestrict['state'] = 'biz_auto_q1';
        $userForRegAndRestrict['biz_auto_form_data'] = []; // Reset form data
        db_save($db);
        tg_sendMessage($chat, 
          "๐ก <b>ููุดููุฏุณุงุฒ ฺฉุณุจโูฺฉุงุฑ ุดูุง ุจุง ATB</b>\n\n" .
          "ุชุตูุฑ ฺฉูุฏ ุฑุจุงุช ุฏุงุดุชู ุจุงุดุฏ ฺฉู ฒด ุณุงุนุชู ุจู ุฌุง ุดูุง ฺฉุงุฑ ฺฉูุฏุ ูุดุชุฑ ูพุฏุง ฺฉูุฏุ ุจู ุณูุงูุงุชุดุงู ุฌูุงุจ ุฏูุฏ ู ุจูุฑูุดุฏ! ูุง ุงู ฺฉุงุฑ ุฑุง ุจุฑุง ุดูุง ุงูุฌุงู ูโุฏูู.\n\n" .
          "ุจุฑุง ุดุฑูุนุ ูุทูุงู ุจู ต ุณูุงู ฺฉูุชุงู ุฌูุงุจ ุฏูุฏ ุชุง ุจุง ฺฉุณุจโูฺฉุงุฑ ุดูุง ุจุดุชุฑ ุขุดูุง ุดูู.\n\n" .
          "ฑ/ต: ูุทูุงู <b>ุฒููู ูุนุงูุช ู ฺฉุณุจโูฺฉุงุฑ</b> ุฎูุฏ ุฑุง ุจู ุทูุฑ ุฎูุงุตู ุดุฑุญ ุฏูุฏ. (ูุซูุงู: ูุฑูุด ุขููุงู ูุจุงุณุ ฺฉููฺฉ ุฒุจุงุ ุขููุฒุด ุจุฑูุงููโููุณ ู...)"
        );
        tg_answerCb($cb["id"]);
        return;
    }
    
    // New Feature: Paid Courses Entry Point
    if ($data === "paid_courses") {
        $paid_courses = array_filter($db['courses'], fn($c) => ($c['price'] ?? 0) > 0);
        if (empty($paid_courses)) {
            tg_sendMessage($chat, "ุฏุฑ ุญุงู ุญุงุถุฑ ุฏูุฑู ูพูู ุจุฑุง ูุฑูุด ูุฌูุฏ ูุฏุงุฑุฏ.", kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู", "back_to_menu")]]));
        } else {
            $rows = [];
            foreach($paid_courses as $course) {
                $rows[] = [btn($course['title'], "view_course:{$course['id']}")];
            }
            $rows[] = [btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ููู ุงุตู", "back_to_menu")];
            tg_sendMessage($chat, "๐ฐ <b>ูุณุช ุขููุฒุดโูุง ูพููุณุงุฒ</b>\n\nุจุฑุง ูุดุงูุฏู ุฌุฒุฆุงุช ู ุฎุฑุฏุ ุฑู ุฏูุฑู ููุฑุฏ ูุธุฑ ฺฉูฺฉ ฺฉูุฏ:", kb($rows));
        }
        tg_answerCb($cb["id"]);
        return;
    }


  // Admin callbacks
  if ($isAdmin) {
    $adminChat = $chat; // In callbacks, chat is the channel where the button was clicked (e.g., support group)

    if (strpos($data,"au:")===0){
      $parts = explode(":", $data);
      $action = $parts[1] ?? "";
      $uid = (int)($parts[2]??0);
      $arg1 = $parts[3] ?? null;
      
      if(!isset($db["users"][$uid])){ tg_answerCb($cb["id"],"ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ."); return; }
      $uu =& user($db, $uid);

      if ($action==="info"){
        tg_editMessageText($adminChat, $msgId, admin_user_summary($uid,$uu, $db), admin_user_kb($uid,$uu));
        tg_answerCb($cb["id"]); return;
      }
      if ($action==="rename"){
        $db["pending_admin_inputs"][$fromId]=["mode"=>"rename","uid"=>$uid]; db_save($db);
        tg_sendMessage($adminChat,"๐ ูุงู ุฌุฏุฏ ฺฉุงุฑุจุฑ {$uid} ุฑุง ุจููุณุฏ.");
        tg_answerCb($cb["id"],"ููุชุธุฑ ูุงูโฆ"); return;
      }
      if ($action==="ban"){
        $uu["banned"]=true; db_save($db);
        tg_sendMessage($uid,"๐ซ ูุชุงุณูุงูู ุฏุณุชุฑุณ ุดูุง ุชูุณุท ูุฏุฑุช ูุณุฏูุฏ ุดุฏ.");
        tg_editMessageText($adminChat, $msgId, admin_user_summary($uid, $uu, $db), admin_user_kb($uid, $uu));
        tg_answerCb($cb["id"], "ฺฉุงุฑุจุฑ ุจู ุดุฏ."); return;
      }
      if ($action==="unban"){
        $uu["banned"]=false; db_save($db);
        tg_sendMessage($uid,"โ ุฏุณุชุฑุณ ุดูุง ุชูุณุท ูุฏุฑุช ุขุฒุงุฏ ุดุฏ.");
        tg_editMessageText($adminChat, $msgId, admin_user_summary($uid, $uu, $db), admin_user_kb($uid, $uu));
        tg_answerCb($cb["id"], "ุจู ฺฉุงุฑุจุฑ ุฑูุน ุดุฏ."); return;
      }
      if ($action==="unlock"){
        $uu["lock_until"]=0; db_save($db);
        tg_sendMessage($uid,"๐ ูุญุฏูุฏุช ุฒูุงู (ุฏุฏูุงู) ุดูุง ุชูุณุท ูพุดุชุจุงู ุจุฑุฏุงุดุชู ุดุฏ. ูโุชูุงู ุจู ฺฉุงุฑุช ุงุฏุงูู ุฏู.");
        tg_editMessageText($adminChat, $msgId, admin_user_summary($uid, $uu, $db), admin_user_kb($uid, $uu));
        tg_answerCb($cb["id"],"ูุญุฏูุฏุช ฺฉุงุฑุจุฑ ุฑูุน ุดุฏ."); return;
      }
      if ($action === "manage_free") {
          $course_id = 1;
          $progress = get_user_course_progress($db, $uid, $course_id);
          $step = ($progress['progress'] ?? -1);
          $total_steps = count(get_course_by_id($db, 1)['content'] ?? []);
          $kb_rows = [];
          $kb_rows[] = [btn("โถ๏ธ ุงุฑุณุงู ูุฑุญูู ุจุนุฏ ุจู ฺฉุงุฑุจุฑ", "au:sendnext:{$uid}:{$course_id}")];
          $kb_rows[] = [btn("โ ุชฺฉูู ูุฑุญูู ูุนู", "au:completestep:{$uid}:{$course_id}"), btn("โช ุจุงุฒฺฏุฑุฏุงูุฏู ุจู ูุฑุญูู ูุจู", "au:revertstep:{$uid}:{$course_id}")];
          $kb_rows[] = [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ฺฉุงุฑุจุฑ", "au:info:{$uid}")];
          tg_editMessageText($adminChat, $msgId, "๐ ูุฏุฑุช ุฏูุฑู ุฑุงฺฏุงู ุจุฑุง ฺฉุงุฑุจุฑ {$uid}\nูุถุนุช ูุนู: ูุฑุญูู ".($step+1)." ุงุฒ {$total_steps}", kb($kb_rows));
          tg_answerCb($cb["id"]); return;
      }
      if ($action === "sendnext") {
          $course_id = (int)$arg1;
          $progress = get_user_course_progress($db, $uid, $course_id);
          $next_step = ($progress['progress'] ?? -1) + 1;
          send_course_step($db, $uid, $course_id, $next_step);
          tg_answerCb($cb["id"], "ูุฑุญูู ุจุนุฏ ุจุฑุง ฺฉุงุฑุจุฑ ุงุฑุณุงู ุดุฏ."); return;
      }
      if ($action === "completestep") {
          $course_id = (int)$arg1;
          if (!isset($db['user_courses'][$uid][$course_id])) $db['user_courses'][$uid][$course_id] = ['status'=>'active', 'progress'=>-1];
          $db['user_courses'][$uid][$course_id]['progress']++;
          db_save($db);
          tg_answerCb($cb["id"], "ูุฑุญูู ุจุง ููููุช ุชฺฉูู ุดุฏ.");
          tg_editMessageText($adminChat, $msgId, "ูุถุนุช ฺฉุงุฑุจุฑ {$uid} ุจูโุฑูุฒ ุดุฏ.\n".admin_user_summary($uid,$uu, $db), admin_user_kb($uid, $uu));
          return;
      }
      if ($action === "revertstep") {
          $course_id = (int)$arg1;
          if (isset($db['user_courses'][$uid][$course_id]) && $db['user_courses'][$uid][$course_id]['progress'] > -1) {
              $db['user_courses'][$uid][$course_id]['progress']--;
          }
          db_save($db);
          tg_answerCb($cb["id"], "ูุฑุญูู ุจุงุฒฺฏุฑุฏุงูุฏู ุดุฏ.");
          tg_editMessageText($adminChat, $msgId, "ูุถุนุช ฺฉุงุฑุจุฑ {$uid} ุจูโุฑูุฒ ุดุฏ.\n".admin_user_summary($uid,$uu, $db), admin_user_kb($uid, $uu));
          return;
      }
      if ($action==="sub_menu"){
        $cur = format_sub_status($db, $uid);
        $rows = [
          [ ["text"=>"โ ุญุฐู ุงุดุชุฑุงฺฉ","callback_data"=>"au:sub:none:".$uid] ],
          [ ["text"=>"ณ ูุงูู","callback_data"=>"au:sub:3m:".$uid], ["text"=>"ถ ูุงูู","callback_data"=>"au:sub:6m:".$uid], ["text"=>"ฑฒ ูุงูู","callback_data"=>"au:sub:12m:".$uid] ],
          [ ["text"=>"โฉ๏ธ ุจุงุฒฺฏุดุช","callback_data"=>"au:info:".$uid] ]
        ];
        tg_editMessageText($adminChat, $msgId, "๐ ุงุดุชุฑุงฺฉ ูุนู: {$cur}\n\nฺฉ ูพูู ุฌุฏุฏ ุจุฑุง ฺฉุงุฑุจุฑ {$uid} ุงูุชุฎุงุจ ฺฉู:", json_encode(["inline_keyboard"=>$rows], JSON_UNESCAPED_UNICODE));
        tg_answerCb($cb["id"]); return;
      }
      if ($action==="sub"){
        $type = $arg1;
        if(!isset($db["subscriptions"])) $db["subscriptions"]=[];
        if($type==="none"){
          unset($db["subscriptions"][$uid]);
        } else {
          $months = ["3m"=>3,"6m"=>6,"12m"=>12][$type] ?? 0;
          if ($months>0){
            $exp = strtotime("+{$months} months");
            $db["subscriptions"][$uid] = ["type"=>$type, "expires_at"=>$exp];
          }
        }
        db_save($db);
        $uu_refreshed = &user($db, $uid); // Re-fetch user data
        tg_editMessageText($adminChat, $msgId, "โ ุงุดุชุฑุงฺฉ ฺฉุงุฑุจุฑ ".$uid." ุจูโุฑูุฒุฑุณุงู ุดุฏ.\n".admin_user_summary($uid,$uu_refreshed, $db), admin_user_kb($uid, $uu_refreshed));
        tg_answerCb($cb["id"],"ุงูุฌุงู ุดุฏ"); return;
      }
    }

    if (strpos($data, "support_reply:")===0) {
      $parts = explode(":", $data);
      $userId = intval($parts[1] ?? 0);
      if ($userId<=0) { tg_answerCb($cb["id"], "ุดูุงุณู ูุงูุนุชุจุฑ"); return; }
      $db["pending_support_replies"][$fromId] = ["user_id"=>$userId]; db_save($db);
      tg_sendMessage($adminChat, "โ๏ธ ูพุงุณุฎ ุฎูุฏ ุฑุง ุจุฑุง ฺฉุงุฑุจุฑ {$userId} ุจูุฑุณุชุฏ. ูโุชูุงูุฏ ูุชูุ ุนฺฉุณุ ููู ุง ูุฑ ูุงู ุฏฺฏุฑ ุงุฑุณุงู ฺฉูุฏ.");
      tg_answerCb($cb["id"], "ููุชุธุฑ ูพุงู ุดูุงโฆ"); return;
    }
    
    // Panel Callbacks
    if (strpos($data, "ap:")===0) {
        $data_parts = explode(":", $data);
        $action = $data_parts[1] ?? 'panel_main';

        if ($action === "noop") { tg_answerCb($cb["id"]); return; }

        if ($action === "panel_main" || $action === "stats") {
          tg_answerCb($cb["id"], ($action === "stats" ? "ุขูุงุฑ ุชุงุฒูโุณุงุฒ ุดุฏ" : ""));
          $all = $db["users"] ?? []; $total = count($all); $todayStart = strtotime('today'); $today = 0;
          foreach($all as $id=>$uu){ if( (int)($uu["created_at"]??0) >= $todayStart ) $today++; }
          $pendingExCount = count($db["pending_exercises"] ?? []); 
          $pendingRecCount = count($db["pending_receipts"] ?? []); 
          $pendingBizCount = count(array_filter($db["business_automation_requests"] ?? [], fn($r) => $r['status'] === 'pending'));
          $openTickets  = count($db["support_open"] ?? []);
          $msg = "๐๏ธ <b>ูพูู ูุฏุฑุช ATB</b> โ ูุณุฎู ".ATB_VERSION."\n\n". "๐ฅ ฺฉู ฺฉุงุฑุจุฑุงู: <b>{$total}</b> | ุงูุฑูุฒ: <b>{$today}</b>\n". "โณ ุชูุฑูโูุง ุฏุฑ ุตู: <b>{$pendingExCount}</b>\n". "๐งพ ุฑุณุฏูุง ุฏุฑ ุตู: <b>{$pendingRecCount}</b>\n". "๐ก ุฏุฑุฎูุงุณุชโูุง ููุดููุฏุณุงุฒ: <b>{$pendingBizCount}</b>\n". "๐ฅ ุชฺฉุชโูุง ูพุดุชุจุงูู ุจุงุฒ: <b>{$openTickets}</b>";
          $kb = json_encode(["inline_keyboard"=>[
            [ ["text"=>"๐ ุชุงุฒูโุณุงุฒ ุขูุงุฑ","callback_data"=>"ap:stats"] ],
            [ ["text"=>"๐ ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู","callback_data"=>"ap:export_menu"] ],
            [ ["text"=>"โณ ุจุฑุฑุณ ุชูุฑูโูุง","callback_data"=>"ap:pending_exercises"], ["text"=>"๐งพ ุจุฑุฑุณ ุฑุณุฏูุง","callback_data"=>"ap:pending_receipts"] ],
            [ ["text"=>"๐ก ุฏุฑุฎูุงุณุชโูุง ููุดููุฏุณุงุฒ","callback_data"=>"ap:biz_auto_requests"] ],
            [ ["text"=>"๐ฅ ุชฺฉุชโูุง ุจุงุฒ","callback_data"=>"ap:support_open"] ],
            [ ["text"=>"๐ ูุฏุฑุช ุฏูุฑูโูุง", "callback_data"=>"ap:manage_courses"], ["text"=>"๐ ูุฏุฑุช ุงุดุชุฑุงฺฉโูุง","callback_data"=>"ap:subs_info"] ],
            [ ["text"=>"๐ข ูพุงู ููฺฏุงู","callback_data"=>"ap:broadcast"] ],
            [ ["text"=>"๐งฐ ุงุจุฒุงุฑฺฉ", "callback_data"=>"ap:manage_toolkit"], ["text"=>"๐ผ๏ธ ุฑุณุงูู ุงุณุชุงุฑุช", "callback_data"=>"ap:manage_start_media"] ],
            [ ["text"=>"๐ณ ฺฉุงุฑุช ุจุงูฺฉ","callback_data"=>"ap:set_vip_card"] ],
            [ ["text"=>"๐ ุฑุงูููุง ุฏุณุชูุฑุงุช","callback_data"=>"ap:commands"] ]
          ]], JSON_UNESCAPED_UNICODE);
          tg_editMessageText($adminChat, $msgId, $msg, $kb);
          return;
        }
        if ($action === "commands"){
          tg_editMessageText($adminChat, $msgId, admin_commands_text(), kb([[btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ุงุตู","ap:panel_main")]]));
          tg_answerCb($cb["id"]); return;
        }
        if ($action === "export_menu") {
            $kb = kb([
                [btn("ุฎุฑูุฌ ฺฉุงูู CSV", "ap:export_request:full:all"), btn("ููุท ุดูุงุฑูโูุง", "ap:export_request:phones:all")],
                [btn("ููุชุฑ: ููู", "ap:noop")],
                [btn("ุฎุฑูุฌ ฺฉุงูู (ุงูุฑูุฒ)", "ap:export_request:full:today"), btn("ุดูุงุฑูโูุง (ุงูุฑูุฒ)", "ap:export_request:phones:today")],
                [btn("ุฎุฑูุฌ ฺฉุงูู (ท ุฑูุฒ ุงุฎุฑ)", "ap:export_request:full:7days"), btn("ุดูุงุฑูโูุง (ท ุฑูุฒ ุงุฎุฑ)", "ap:export_request:phones:7days")],
                [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ุงุตู", "ap:panel_main")]
            ]);
            tg_editMessageText($adminChat, $msgId, "๐ <b>ุฎุฑูุฌ ฺฉุงุฑุจุฑุงู</b>\n\nูุทูุงู ููุน ุฎุฑูุฌ ู ููุชุฑ ุฒูุงู ููุฑุฏ ูุธุฑ ุฎูุฏ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:", $kb);
            tg_answerCb($cb["id"]);
            return;
        }
        if ($action === "export_request") {
            tg_answerCb($cb["id"], "ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ุฎุฑูุฌ...");
            $type = $data_parts[2] ?? 'full';
            $filter = $data_parts[3] ?? 'all';
            
            $time_limit = 0;
            if ($filter === 'today') {
                $time_limit = strtotime('today');
            } elseif ($filter === '7days') {
                $time_limit = strtotime('-7 days');
            }

            $lines = [];
            $users = array_filter($db["users"], fn($u) => ($u["created_at"] ?? 0) >= $time_limit);

            if ($type === "full") {
                $lines[] = "UserID,Name,Phone,Job,AI Level,Register Date";
                foreach($users as $uid => $u_data) {
                    $name = '"' . str_replace('"', '""', $u_data["name"] ?? '') . '"';
                    $job = '"' . str_replace('"', '""', $u_data["job"] ?? '') . '"';
                    $phone = $u_data['phone'] ?? '';
                    $ai = $u_data['ai'] ?? '';
                    $date = to_jalali($u_data["created_at"] ?? 0, 'Y-m-d H:i');
                    $lines[] = "{$uid},{$name},{$phone},{$job},{$ai},{$date}";
                }
            } else { // phones
                foreach($users as $uid => $u_data) {
                    if (!empty($u_data["phone"])) {
                        $lines[] = $u_data["phone"];
                    }
                }
            }
            tg_sendMessage($adminChat, "โ ุฎุฑูุฌ ุดูุง ุจุง ููุชุฑ ยซ{$filter}ยป ุขูุงุฏู ุดุฏ:");
            send_lines_in_chunks($adminChat, $lines);
            return;
        }
        if ($action === "pending_exercises") {
          $items = $db["pending_exercises"] ?? [];
          if (empty($items)) { tg_sendMessage($adminChat, "ูฺ ุชูุฑู ุฏุฑ ุตู ุงูุชุธุงุฑ ูุณุช."); tg_answerCb($cb["id"]); return; }
          tg_answerCb($cb["id"], "ุฏุฑ ุญุงู ุงุฑุณุงู ุชูุฑูโูุง ุฏุฑ ุตู...");
          foreach ($items as $it) {
              $uid = $it["user_id"];
              $mid = $it["orig_mid"] ?? null;
              if ($mid) { tg_forwardMessage($adminChat, $uid, $mid); }
              $uu = $db["users"][$uid] ?? null;
              $course = get_course_by_id($db, $it['course_id']);
              $course_title = $course['title'] ?? 'ูุงูุดุฎุต';
              $humanStep = $it["step"] + 1;
              $info = "๐ <b>ุชูุฑู โ {$course_title} (ูุฑุญูู {$humanStep})</b>\n"
                    . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$uid}\">".$uid."</a> | ".($uu["name"]??'-');
              tg_sendMessage($adminChat, $info, admin_exercise_kb($uid, $it['course_id'], $it['step']));
              usleep(300000); // prevent flood
          }
          return;
        }
        if ($action === "pending_receipts") {
          $items = $db["pending_receipts"] ?? [];
          if (empty($items)) { tg_sendMessage($adminChat, "ูฺ ุฑุณุฏ ุฏุฑ ุตู ุงูุชุธุงุฑ ูุณุช."); tg_answerCb($cb["id"]); return; }
          tg_answerCb($cb["id"], "ุฏุฑ ุญุงู ุงุฑุณุงู ุฑุณุฏูุง ุฏุฑ ุตู...");
          foreach ($items as $it) {
              $uid = $it["user_id"];
              $mid = $it["orig_mid"] ?? null;
              if ($mid) { tg_forwardMessage($adminChat, $uid, $mid); }
              $uu = $db["users"][$uid] ?? null;
              $course = get_course_by_id($db, $it['course_id']);
              $course_title = $course['title'] ?? 'ูุงูุดุฎุต';
              $info = "๐งพ <b>ุฑุณุฏ ุจุฑุง ุฏูุฑู: {$course_title}</b>\n"
                    . "๐ค ฺฉุงุฑุจุฑ: <a href=\"tg://user?id={$uid}\">".$uid."</a> | ".($uu["name"]??'-');
              tg_sendMessage($adminChat, $info, admin_receipt_kb($uid, $it['course_id']));
              usleep(300000); // prevent flood
          }
          return;
        }
        if ($action === "biz_auto_requests") {
            tg_answerCb($cb["id"]);
            $requests = array_reverse(array_filter($db["business_automation_requests"] ?? [], fn($r) => $r['status'] === 'pending'));
            if (empty($requests)) {
                tg_editMessageText($adminChat, $msgId, "๐ก ูฺ ุฏุฑุฎูุงุณุช ููุดููุฏุณุงุฒ ุฌุฏุฏ ูุฌูุฏ ูุฏุงุฑุฏ.", kb([[btn("โฉ๏ธ ุจุงุฒฺฏุดุช", "ap:panel_main")]]));
                return;
            }
            tg_editMessageText($adminChat, $msgId, "๐ก ูุณุช ุฏุฑุฎูุงุณุชโูุง ุฏุฑ ุงูุชุธุงุฑ:", kb([[btn("โฉ๏ธ ุจุงุฒฺฏุดุช", "ap:panel_main")]]));
            $counter = 0;
            foreach($requests as $req) {
                $uid = $req['user_id'];
                $user_info = $db['users'][$uid] ?? null;
                $name = $user_info['name'] ?? 'ูุงุดูุงุณ';
                $time = to_jalali($req['time']);
                $summary_text = "<b>ุฏุฑุฎูุงุณุช ุงุฒ {$name}</b> (<code>{$uid}</code>)\nุฏุฑ ุชุงุฑุฎ: {$time}\nุฒููู: ".($req['data']['q1'] ?? 'โ');
                $kb = kb([[ btn("๐๏ธ ูุดุงูุฏู ฺฉุงูู", "ap:biz_view:{$req['id']}"), btn("โ ุงูุฌุงู ุดุฏ", "ap:biz_done:{$req['id']}") ]]);
                tg_sendMessage($adminChat, $summary_text, $kb);
                usleep(300000);
                $counter++;
                if ($counter >= 10) {
                     tg_sendMessage($adminChat, "โ๏ธ ููุท ฑฐ ุฏุฑุฎูุงุณุช ุขุฎุฑ ููุงุด ุฏุงุฏู ุดุฏ.");
                     break;
                }
            }
            return;
        }
        if (strpos($data, "ap:biz_view:") === 0) {
            $req_id = explode(":", $data)[2];
            $request = null;
            foreach($db['business_automation_requests'] as $req) { if ($req['id'] === $req_id) { $request = $req; break; } }
            if(!$request) { tg_answerCb($cb['id'], "ุฏุฑุฎูุงุณุช ุงูุช ูุดุฏ."); return; }
            $uid = $request['user_id'];
            $user_info = $db['users'][$uid] ?? null;
            $answers = $request['data'];
            $summary = "๐ก <b>ุฌุฒุฆุงุช ุฏุฑุฎูุงุณุช ููุดููุฏุณุงุฒ</b>\n\n"
                       . "๐ค ฺฉุงุฑุจุฑ: <a href='tg://user?id={$uid}'>{$uid}</a> | ".($user_info['name'] ?? 'ุซุจุช ูุดุฏู')."\n"
                       . "<b>ฑ. ุฒููู ูุนุงูุช:</b> " . ($answers['q1'] ?? 'โ') . "\n"
                       . "<b>ฒ. ูุดุชุฑุงู ูุฏู:</b> " . ($answers['q2'] ?? 'โ') . "\n"
                       . "<b>ณ. ุจุฒุฑฺฏโุชุฑู ฺุงูุด:</b> " . ($answers['q3'] ?? 'โ') . "\n"
                       . "<b>ด. ุขุฏุฑุณโูุง:</b> " . ($answers['q4'] ?? 'โ') . "\n"
                       . "<b>ต. ุงุทูุงุนุงุช ุชูุงุณ:</b> " . ($answers['q5'] ?? 'โ') . "\n\n"
                       . "#{$req_id}";
            tg_editMessageText($adminChat, $msgId, $summary, kb([[ btn("โ ุงูุฌุงู ุดุฏ", "ap:biz_done:{$req_id}"), btn("โฉ๏ธ ุจุงุฒฺฏุดุช", "ap:biz_auto_requests")]]));
            return;
        }
        if (strpos($data, "ap:biz_done:") === 0) {
            $req_id = explode(":", $data)[2];
            foreach($db['business_automation_requests'] as $index => &$req) {
                if ($req['id'] === $req_id) {
                    $req['status'] = 'done';
                    break;
                }
            }
            db_save($db);
            tg_editMessageText($adminChat, $msgId, "โ ุฏุฑุฎูุงุณุช #{$req_id} ุจู ุนููุงู ยซุงูุฌุงู ุดุฏูยป ุนูุงูุชโฺฏุฐุงุฑ ุดุฏ.");
            tg_answerCb($cb["id"], "ุงูุฌุงู ุดุฏ.");
            return;
        }
        if ($action === "support_open") {
            tg_answerCb($cb["id"]);
            $tickets = array_reverse($db["support_open"] ?? []);
            if (empty($tickets)) {
                tg_editMessageText($adminChat, $msgId, "๐ฅ ูฺ ุชฺฉุช ุจุงุฒ ูุฌูุฏ ูุฏุงุฑุฏ.", kb([[btn("โฉ๏ธ ุจุงุฒฺฏุดุช", "ap:panel_main")]]));
                return;
            }
            tg_editMessageText($adminChat, $msgId, "๐ฅ ูุณุช ุชฺฉุชโูุง ุจุงุฒ:", kb([[btn("โฉ๏ธ ุจุงุฒฺฏุดุช", "ap:panel_main")]]));
            foreach($tickets as $ticket) {
                $uid = $ticket['user_id'];
                $user_info = $db['users'][$uid] ?? null;
                $name = $user_info['name'] ?? 'ูุงุดูุงุณ';
                $time = to_jalali($ticket['time']);
                $last_text = mb_substr($ticket['last_text'], 0, 50);
                if(mb_strlen($ticket['last_text']) > 50) $last_text .= '...';
                
                $summary_text = "<b>ุชฺฉุช ุงุฒ {$name}</b> (<code>{$uid}</code>)\nุขุฎุฑู ูพุงู: {$time}\n<i>{$last_text}</i>";
                tg_sendMessage($adminChat, $summary_text, admin_support_kb($uid));
                usleep(300000);
            }
            return;
        }
        if ($action === "broadcast") {
            $db["pending_broadcast"] = ["admin_id" => $fromId, "message" => null];
            db_save($db);
            tg_sendMessage($adminChat, "๐ข <b>ุงุฑุณุงู ูพุงู ููฺฏุงู</b>\n\nูุทูุงู ูพุงู ฺฉู ูโุฎูุงูุฏ ุจู ููู ฺฉุงุฑุจุฑุงู ุงุฑุณุงู ุดูุฏ ุฑุง ุจูุฑุณุชุฏ. (ูุชูุ ุนฺฉุณุ ูุฏุฆู ู...)", kb([[btn("โ ูุบู ุนููุงุช", "ap:broadcast_cancel")]]));
            tg_answerCb($cb["id"]); return;
        }
        if ($action === "broadcast_cancel") {
            $db["pending_broadcast"] = null;
            db_save($db);
            tg_editMessageText($adminChat, $msgId, "ุนููุงุช ุงุฑุณุงู ูพุงู ููฺฏุงู ูุบู ุดุฏ.");
            tg_answerCb($cb["id"]); return;
        }
        if ($action === "broadcast_confirm") {
            $broadcast_data = $db["pending_broadcast"];
            if (!$broadcast_data || !$broadcast_data["message"]) {
                tg_editMessageText($adminChat, $msgId, "ุฎุทุง: ูพุงู ุจุฑุง ุงุฑุณุงู ุงูุช ูุดุฏ.");
                return;
            }
            
            tg_answerCb($cb["id"], "ุดุฑูุน ุงุฑุณุงู...");
            tg_editMessageText($adminChat, $msgId, "ุฏุฑ ุญุงู ุงุฑุณุงู ูพุงู... ูุทูุงู ุตุจุฑ ฺฉูุฏ.");
            
            $all_users = array_keys($db["users"]);
            $total_users = count($all_users);
            $sent_count = 0;
            $failed_count = 0;
            
            foreach ($all_users as $user_id) {
                $res = tg_copyMessage($user_id, $broadcast_data["message"]["chat"]["id"], $broadcast_data["message"]["message_id"]);
                if ($res && $res['ok']) {
                    $sent_count++;
                } else {
                    $failed_count++;
                }
                if (($sent_count + $failed_count) % 20 == 0) { // Update admin every 20 users
                    tg_editMessageText($adminChat, $msgId, "ุฏุฑ ุญุงู ุงุฑุณุงู... ({$sent_count}/{$total_users})");
                }
                usleep(300000); // 300ms delay
            }
            
            tg_editMessageText($adminChat, $msgId, "โ <b>ุงุฑุณุงู ูพุงู ููฺฏุงู ุชฺฉูู ุดุฏ!</b>\n\n- ูููู: {$sent_count}\n- ูุงูููู: {$failed_count}");
            $db["pending_broadcast"] = null;
            db_save($db);
            return;
        }
        if ($action === "manage_courses") {
          $rows = [];
          foreach($db['courses'] as $course) {
              $price = $course['price'] > 0 ? number_format($course['price']).' ุช' : 'ุฑุงฺฏุงู';
              $label = "{$course['title']} ({$price})";
              $rows[] = [btn($label, "ap:edit_course:{$course['id']}")];
          }
          $rows[] = [btn("โ ุงูุฒูุฏู ุฏูุฑู ุฌุฏุฏ", "ap:add_course")];
          $rows[] = [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ุงุตู", "ap:panel_main")];
          tg_editMessageText($adminChat, $msgId, "๐ <b>ูุฏุฑุช ุฏูุฑูโูุง</b>\n\nุจุฑุง ูุฑุงุด ุง ุญุฐู ฺฉ ุฏูุฑูุ ุขู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.", kb($rows));
          tg_answerCb($cb["id"]); return;
        }
        if (strpos($data, "ap:edit_course:") === 0) {
            $course_id = (int)$data_parts[2];
            $course = get_course_by_id($db, $course_id);
            if (!$course) { tg_answerCb($cb['id'], 'ุฏูุฑู ุงูุช ูุดุฏ'); return; }

            $price_text = $course['price'] > 0 ? number_format($course['price']).' ุชููุงู' : 'ุฑุงฺฏุงู';
            $text = "โ๏ธ <b>ูุฑุงุด ุฏูุฑู: {$course['title']}</b>\n\n"
                  . "<b>ููุช:</b> {$price_text}\n"
                  . "<b>ุชูุถุญุงุช:</b> " . mb_substr($course['description'], 0, 150) . "...\n"
                  . "<b>ุชุนุฏุงุฏ ูุฑุงุญู:</b> " . count($course['content']);

            $kb = kb([
                [btn("โ๏ธ ูุฑุงุด ุนููุงู", "ap:set_course_prop:{$course_id}:title"), btn("โ๏ธ ูุฑุงุด ุชูุถุญุงุช", "ap:set_course_prop:{$course_id}:description")],
                [btn("โ๏ธ ูุฑุงุด ููุช", "ap:set_course_prop:{$course_id}:price"), btn("๐ ูุฏุฑุช ูุฑุงุญู", "ap:manage_steps:{$course_id}")],
                [btn("๐๏ธ ุญุฐู ฺฉุงูู ุงู ุฏูุฑู", "ap:del_course_confirm:{$course_id}")],
                [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูุณุช ุฏูุฑูโูุง", "ap:manage_courses")]
            ]);
            tg_editMessageText($adminChat, $msgId, $text, $kb);
            tg_answerCb($cb["id"]);
            return;
        }
        if (strpos($data, "ap:manage_steps:") === 0) {
            $course_id = (int)$data_parts[2];
            $course = get_course_by_id($db, $course_id);
            if (!$course) { tg_answerCb($cb['id'], 'ุฏูุฑู ุงูุช ูุดุฏ'); return; }

            $text = "๐ <b>ูุฏุฑุช ูุฑุงุญู ุฏูุฑู: {$course['title']}</b>\n\n";
            if (empty($course['content'])) {
                $text .= "ุงู ุฏูุฑู ูููุฒ ูฺ ูุฑุญููโุง ูุฏุงุฑุฏ.";
            } else {
                foreach ($course['content'] as $index => $step) {
                    $step_num = $index + 1;
                    $caption_preview = mb_substr(trim($step['caption']), 0, 30);
                    $text .= "<b>ูุฑุญูู {$step_num}:</b> {$step['type']} - <i>{$caption_preview}...</i>\n";
                }
            }

            $kb_rows = [];
            if (!empty($course['content'])) {
                $last_step_index = count($course['content']) - 1;
                $kb_rows[] = [btn("๐๏ธ ุญุฐู ุขุฎุฑู ูุฑุญูู", "ap:delete_step:{$course_id}:{$last_step_index}")];
            }
            $kb_rows[] = [btn("โ ุงูุฒูุฏู ูุฑุญูู ุฌุฏุฏ", "ap:add_step:{$course_id}")];
            $kb_rows[] = [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูุฑุงุด ุฏูุฑู", "ap:edit_course:{$course_id}")];

            tg_editMessageText($adminChat, $msgId, $text, kb($kb_rows));
            tg_answerCb($cb["id"]);
            return;
        }
        if (strpos($data, "ap:set_course_prop:") === 0) {
            $course_id = (int)$data_parts[2];
            $prop = $data_parts[3];
            $prop_map = ['title' => 'ุนููุงู', 'description' => 'ุชูุถุญุงุช', 'price' => 'ููุช'];
            if (!isset($prop_map[$prop])) return;

            $db["pending_admin_inputs"][$fromId] = ["mode" => "edit_course_{$prop}", "course_id" => $course_id];
            db_save($db);
            tg_sendMessage($adminChat, "ูุทูุงู {$prop_map[$prop]} ุฌุฏุฏ ุฑุง ุงุฑุณุงู ฺฉูุฏ.");
            tg_answerCb($cb["id"]);
            return;
        }
        if (strpos($data, "ap:add_step:") === 0) {
             $course_id = (int)$data_parts[2];
             $db["pending_admin_inputs"][$fromId] = ["mode" => "add_course_step", "course_id" => $course_id];
             db_save($db);
             tg_sendMessage($adminChat, "โ <b>ุงูุฒูุฏู ูุฑุญูู ุฌุฏุฏ</b>\n\nูุทูุงู ูุฏุฆู ุง ุนฺฉุณ ูุฑุญูู ุฌุฏุฏ ุฑุง ููุฑูุงุฑุฏ ฺฉูุฏ. ฺฉูพุดู ูพุงู ุจู ุนููุงู ูุชู ูุฑุญูู ุฐุฎุฑู ุฎูุงูุฏ ุดุฏ.\n\nูพุณ ุงุฒ ุงุฑุณุงู ุชูุงู ูุฑุงุญู ุฌุฏุฏุ ุฏุณุชูุฑ /done ุฑุง ุจูุฑุณุชุฏ.");
             tg_answerCb($cb["id"]);
             return;
        }
        if (strpos($data, "ap:delete_step:") === 0) {
            $course_id = (int)$data_parts[2];
            $step_index = (int)$data_parts[3];
            foreach($db['courses'] as &$course) {
                if ($course['id'] == $course_id) {
                    if (isset($course['content'][$step_index])) {
                        array_splice($course['content'], $step_index, 1);
                        tg_answerCb($cb["id"], "โ ูุฑุญูู ุจุง ููููุช ุญุฐู ุดุฏ.");
                    } else {
                        tg_answerCb($cb["id"], "โ๏ธ ูุฑุญูู ุงูุช ูุดุฏ.");
                    }
                    break;
                }
            }
            db_save($db);
            // Auto-refresh the step management menu by re-sending the message
            $data = "ap:manage_steps:" . $course_id; // Fake the data to re-trigger the handler
        }
        if (strpos($data, "ap:del_course_confirm:") === 0) {
            $course_id = (int)$data_parts[2];
            $course = get_course_by_id($db, $course_id);
            if (!$course) { tg_answerCb($cb['id'], 'ุฏูุฑู ุงูุช ูุดุฏ'); return; }
            tg_editMessageText($adminChat, $msgId, "ุขุง ุงุฒ ุญุฐู ฺฉุงูู ุฏูุฑู ยซ{$course['title']}ยป ูุทูุฆู ูุณุชุฏุ ุงู ุนูู ุบุฑูุงุจู ุจุงุฒฺฏุดุช ุงุณุช.", kb([
                [btn(" ุจููุ ุญุฐู ฺฉู", "ap:del_course:{$course_id}"), btn(" ุฎุฑุ ุงูุตุฑุงู", "ap:edit_course:{$course_id}")]
            ]));
            tg_answerCb($cb["id"]);
            return;
        }
        if (strpos($data, "ap:del_course:") === 0) {
            $course_id = (int)$data_parts[2];
            if ($course_id == 1) { // Prevent deleting free course
                tg_answerCb($cb["id"], "โ๏ธ ุฏูุฑู ููุฏูุงุช ูุงุจู ุญุฐู ูุณุช."); return;
            }
            $db['courses'] = array_values(array_filter($db['courses'], fn($c) => $c['id'] != $course_id));
            db_save($db);
            tg_answerCb($cb["id"], "ุฏูุฑู ุญุฐู ุดุฏ โ");
            // Refresh main course menu
            $data = "ap:manage_courses"; // Fake the data to re-trigger the handler
        }

        if ($action === "add_course") {
          $db["pending_admin_inputs"][$fromId] = ["mode" => "course_title", "price" => 0, "content" => []];
          db_save($db);
          tg_sendMessage($adminChat, "โถ๏ธ <b>ุดุฑูุน ูุฑุขูุฏ ุงูุฒูุฏู ุฏูุฑู ุฌุฏุฏ</b>\n\nูุทูุงู <b>ุนููุงู ุฏูุฑู</b> ุฑุง ุงุฑุณุงู ฺฉูุฏ.");
          tg_answerCb($cb["id"]); return;
        }
        if($action === "set_vip_card"){
          $db["await_set_vip_card"][$fromId] = true;
          db_save($db);
          tg_sendMessage($adminChat, "๐ณ ูุทูุงู ุนฺฉุณ ุฌุฏุฏ ฺฉุงุฑุช ุจุงูฺฉ ุจุฑุง ูพุฑุฏุงุฎุชโูุง VIP ุฑุง ุงุฑุณุงู ฺฉูุฏ.");
          tg_answerCb($cb["id"]); return;
        }
        if($action === "subs_info"){
          $now = time();
          $expiring_limit = $now + 7 * 24 * 3600;
          $counts = ['active' => 0, 'expiring' => 0, 'expired' => 0, 'none' => count($db['users'])];

          foreach($db['subscriptions'] as $uid => $sub) {
              if (($sub["expires_at"] ?? 0) > $now) {
                  $counts['active']++;
                  if (($sub["expires_at"] ?? 0) < $expiring_limit) {
                      $counts['expiring']++;
                  }
              } else {
                  $counts['expired']++;
              }
          }
          $counts['none'] -= count($db['subscriptions']);

          $kb = kb([
              [btn("โ ฺฉุงุฑุจุฑุงู ูุนุงู ({$counts['active']})", "ap:subs:active")],
              [btn("โ๏ธ ุฏุฑ ุญุงู ุงููุถุง ({$counts['expiring']})", "ap:subs:expiring")],
              [btn("โ ูููุถ ุดุฏู ({$counts['expired']})", "ap:subs:expired")],
              [btn("โ ุจุฏูู ุงุดุชุฑุงฺฉ ({$counts['none']})", "ap:subs:none")],
              [btn("โฉ๏ธ ุจุงุฒฺฏุดุช ุจู ูพูู ุงุตู", "ap:panel_main")]
          ]);
          tg_editMessageText($adminChat, $msgId, "๐ <b>ูุฏุฑุช ุงุดุชุฑุงฺฉโูุง VIP</b>\n\nฺฉุฏุงู ุฏุณุชู ุงุฒ ฺฉุงุฑุจุฑุงู ููุงุด ุฏุงุฏู ุดููุฏุ", $kb);
          tg_answerCb($cb["id"]); return;
        }
        if ($action === 'subs') {
          $filter = $data_parts[2];
          $now = time();
          $expiring_limit = $now + 7 * 24 * 3600;
          $lines = [];
          $all_user_ids = array_keys($db['users']);
          $subscribed_user_ids = array_keys($db['subscriptions'] ?? []);

          if ($filter === 'none') {
              $unsubscribed_ids = array_diff($all_user_ids, $subscribed_user_ids);
              foreach($unsubscribed_ids as $uid){
                  $user = $db["users"][$uid];
                  $name = $user["name"] ?? "ุจโูุงู";
                  $lines[] = "โข <code>{$uid}</code> | {$name}";
              }
          } else {
              foreach($db['subscriptions'] as $uid => $sub) {
                  if (!isset($db['users'][$uid])) continue;
                  $user = $db['users'][$uid];
                  $name = $user["name"] ?? "ุจโูุงู";
                  $exp_date_str = to_jalali($sub["expires_at"]);
                  
                  if ($filter === 'active' && ($sub["expires_at"] ?? 0) > $now) {
                      $lines[] = "โข <code>{$uid}</code> | {$name} | ุชุง: {$exp_date_str}";
                  } elseif ($filter === 'expiring' && ($sub["expires_at"] ?? 0) > $now && ($sub["expires_at"] ?? 0) < $expiring_limit) {
                      $lines[] = "โข <code>{$uid}</code> | {$name} | ุชุง: {$exp_date_str}";
                  } elseif ($filter === 'expired' && ($sub["expires_at"] ?? 0) <= $now) {
                      $lines[] = "โข <code>{$uid}</code> | {$name} | ุฏุฑ: {$exp_date_str}";
                  }
              }
          }
          
          $title_map = ['active' => 'โ ฺฉุงุฑุจุฑุงู ุจุง ุงุดุชุฑุงฺฉ ูุนุงู', 'expiring' => 'โ๏ธ ุงุดุชุฑุงฺฉโูุง ุฏุฑ ุญุงู ุงููุถุง', 'expired' => 'โ ุงุดุชุฑุงฺฉโูุง ูููุถ ุดุฏู', 'none' => 'โ ฺฉุงุฑุจุฑุงู ุจุฏูู ุงุดุชุฑุงฺฉ'];
          $title = $title_map[$filter] ?? 'ูุณุช ฺฉุงุฑุจุฑุงู';
          tg_sendMessage($adminChat, "<b>{$title}:</b>");
          send_lines_in_chunks($adminChat, $lines);
          tg_answerCb($cb["id"]); return;
        }
    }
    
    // Exercise approval
    if (strpos($data, "admin_ex_ok:") === 0 || strpos($data, "admin_ex_no:") === 0) {
        list(, $userId, $courseId, $step) = explode(":", $data);
        $userId = (int)$userId; $courseId = (int)$courseId; $step = (int)$step;
        
        if (!isset($db["users"][$userId])) { tg_answerCb($cb["id"], "ฺฉุงุฑุจุฑ ูพุฏุง ูุดุฏ."); return; }
        $uu_ex =& user($db, $userId);
        if (strpos($data, "admin_ex_ok:") === 0) {
            remove_pending_exercise($db, $userId, $courseId, $step);
            if (!isset($db['user_courses'][$userId][$courseId])) $db['user_courses'][$userId][$courseId] = ['status'=>'active', 'progress'=>-1];
            $db['user_courses'][$userId][$courseId]['progress'] = $step;
            
            $course = get_course_by_id($db, $courseId);
            $next_step = $step + 1;
            if ($next_step < count($course['content'])) {
                tg_sendMessage($userId, "โ ุชูุฑู ุดูุง ุชุงุฏ ุดุฏ! ุจุฑูู ุณุฑุงุบ ูุฑุญูู ุจุนุฏ.");
                send_course_step($db, $userId, $courseId, $next_step);
            } else {
                $db['user_courses'][$userId][$courseId]['status'] = 'completed';
                $uu_ex['state'] = 'completed_free';
                $finalText = "๐ <b>ุชุจุฑฺฉ!</b>\nุฏูุฑู ยซ{$course['title']}ยป ุฑุง ุจุง ููููุช ุชูุงู ฺฉุฑุฏ.\n\n"
                           . "ุจู ูพุงุณ ุชูุงุด ุดูุงุ ุงุฒ ุงูุงู ุนุถู ฺฉุงูุงู ุฎุตูุต <b>ATB Club</b> ูุณุช. ุฑู ุฏฺฉูู ุฒุฑ ุจุฒู ู ูุงุฑุฏ ุดู:";
                $finalKb = kb([[["text" => "๐ช ูุฑูุฏ ุจู ฺฉูุงุจ ATB", "url" => $GLOBALS["PRIVATE_CHANNEL_INVITE"]]]]);
                tg_sendMessage($userId, $finalText, $finalKb);
                // Referral Payout Logic
                if ($courseId == 1 && !empty($uu_ex['referrer_id']) && empty($uu_ex['referral_paid_out'])) {
                    $referrer_id = $uu_ex['referrer_id'];
                    if (isset($db['users'][$referrer_id])) {
                        global $REFERRAL_REWARD_AMOUNT, $REFERRAL_REWARD_TEXT;
                        $ref_user =& user($db, $referrer_id);
                        $ref_user['referral_balance_usd'] = ($ref_user['referral_balance_usd'] ?? 0) + $REFERRAL_REWARD_AMOUNT;
                        tg_sendMessage($referrer_id, "ุฎุจุฑ ุนุงู! ฺฉ ุงุฒ ุฏูุณุชุงู ฺฉู ุฏุนูุช ฺฉุฑุฏู ุจูุฏุ ุขููุฒุด ููุฏูุงุช ุฑุง ุชูุงู ฺฉุฑุฏ.\nูุจูุบ <b>" . $REFERRAL_REWARD_TEXT . "</b> ุจู ฺฉู ูพูู ุดูุง ุงุถุงูู ุดุฏ.\nููุฌูุฏ ูุนู: " . ($ref_user['referral_balance_usd']) . " ุฏูุงุฑ");
                        $uu_ex['referral_paid_out'] = true; // Flag to prevent double payout
                    }
                }
            }
            tg_editMessageText($adminChat, $msgId, "โ ุชูุฑู ฺฉุงุฑุจุฑ {$userId} ุชุงุฏ ุดุฏ.");
            tg_answerCb($cb["id"]);
            db_save($db); return;
        }

        if (strpos($data, "admin_ex_no:") === 0) {
            $db["pending_rejects"][$fromId] = ["user_id"=>$userId, "course_id"=>$courseId, "step"=>$step];
            remove_pending_exercise($db, $userId, $courseId, $step);
            db_save($db);
            $hs = $step + 1;
            tg_editMessageText($adminChat, $msgId, "โ ุฑุฏ ุชูุฑู ูุฑุญูู {$hs} ุงูุชุฎุงุจ ุดุฏ.\nุญุงูุง ูุทูุงู <b>ุฏูู ุฑุฏ ฺฉุฑุฏู</b> ุฑุง ุฏุฑ ฺฉ ูพุงู ุฌุฏุฏ ุจูุฑุณุชุฏ ุชุง ุจุฑุง ฺฉุงุฑุจุฑ ุงุฑุณุงู ุดูุฏ.");
            tg_answerCb($cb["id"], "ููุชุธุฑ ุฏููโฆ"); return;
        }
    }
    
    // Receipt approval
    if (strpos($data, "admin_receipt_ok:") === 0 || strpos($data, "admin_receipt_no:") === 0) {
        list(, $userId, $courseId) = explode(":", $data);
        $userId = (int)$userId; $courseId = (int)$courseId;
        
        if (!isset($db["users"][$userId])) { tg_answerCb($cb["id"], "ฺฉุงุฑุจุฑ ูพุฏุง ูุดุฏ."); return; }
        
        // Remove from pending list
        $db['pending_receipts'] = array_values(array_filter($db['pending_receipts'], fn($it) => !($it['user_id'] == $userId && $it['course_id'] == $courseId)));
        
        if (strpos($data, "admin_receipt_ok:") === 0) {
            $db['user_courses'][$userId][$courseId] = ['status'=>'active', 'progress'=>-1, 'receipt_file_id'=>'approved'];
            $course = get_course_by_id($db, $courseId);
            tg_sendMessage($userId, "โ ูพุฑุฏุงุฎุช ุดูุง ุจุฑุง ุฏูุฑู ยซ{$course['title']}ยป ุชุงุฏ ุดุฏ!\n\nุจุฑุง ุดุฑูุน ุฏูุฑู ุฑู ุฏฺฉูู ุฒุฑ ฺฉูฺฉ ฺฉูุฏ.", kb([[btn("๐ ุดุฑูุน ุฏูุฑู", "start_paid_course:{$courseId}")]]) );
            tg_editMessageText($adminChat, $msgId, "โ ุฑุณุฏ ฺฉุงุฑุจุฑ {$userId} ุจุฑุง ุฏูุฑู ยซ{$course['title']}ยป ุชุงุฏ ุดุฏ.");
            tg_answerCb($cb["id"]);
        } else { // admin_receipt_no
            $course = get_course_by_id($db, $courseId);
            tg_sendMessage($userId, "โ ูุชุงุณูุงูู ูพุฑุฏุงุฎุช ุดูุง ุจุฑุง ุฏูุฑู ยซ{$course['title']}ยป ุฑุฏ ุดุฏ.\n\nูุทูุงู ุจุง ูพุดุชุจุงู ุชูุงุณ ุจฺฏุฑุฏ ุชุง ูุดฺฉู ุฑุง ุจุฑุฑุณ ฺฉูู.", only_support_kb());
            tg_editMessageText($adminChat, $msgId, "โ ุฑุณุฏ ฺฉุงุฑุจุฑ {$userId} ุจุฑุง ุฏูุฑู ยซ{$course['title']}ยป ุฑุฏ ุดุฏ ู ุจู ุงู ุงุทูุงุน ุฏุงุฏู ุดุฏ.");
            tg_answerCb($cb["id"]);
        }

        db_save($db);
        return;
    }

    if (strpos($data, "admin_vip_ok:") === 0) {
        list(, $userId, $sub_type) = explode(":", $data);
        $userId = intval($userId);

        if (isset($db["users"][$userId])) {
            $user_vip =& user($db, $userId);
            $user_vip["state"] = "idle";
            
            $months_map = ["3m" => 3, "6m" => 6, "12m" => 12];
            $months = $months_map[$sub_type] ?? 12; // Default to 12 if something goes wrong
            
            if(!isset($db["subscriptions"])) $db["subscriptions"] = [];
            $db["subscriptions"][$userId] = ["type"=>$sub_type, "expires_at"=>strtotime("+{$months} months")];
            db_save($db);
            
            $kb_vip = json_encode(["inline_keyboard" => [[["text" => "๐ ูุฑูุฏ ุจู ฺฉุงูุงู VIP", "url" => $GLOBALS["VIP_PRIVATE_INVITE"]]]]], JSON_UNESCAPED_UNICODE);
            tg_sendMessage($userId, "โ ูพุฑุฏุงุฎุช ุดูุง ุชุงุฏ ุดุฏ! ุจู ุฌูุน ุงุนุถุง ูฺู ATB Club ุฎูุด ุขูุฏุฏ.\n\n๐ ุจุง ููฺฉ ุฒุฑ ูุงุฑุฏ ฺฉุงูุงู ุงุฎุชุตุงุต ุดูุฏ:", $kb_vip);
            tg_editMessageText($adminChat, $msgId, "โ ุงุดุชุฑุงฺฉ VIP ({$months} ูุงูู) ุจุฑุง ฺฉุงุฑุจุฑ {$userId} ุชุงุฏ ู ูุนุงู ุดุฏ.");
            tg_answerCb($cb["id"]);
        } else {
            tg_answerCb($cb["id"], "ฺฉุงุฑุจุฑ ุงูุช ูุดุฏ.");
        }
        return;
    }
  }

  if ($data === "support_contact") {
    $userForRegAndRestrict["state"] = "support_await_msg";
    db_save($db);
    tg_sendMessage($chat, "๐ ุขูุงุฏู ุดูุฏู ุณูุงู ุง ูุดฺฉู ุดูุง ูุณุชู.\n\nูุฑ ฺุฒ ฺฉู ูุณุช ุฑุง ุงูุฌุง ุจููุณุฏ ุง ูุงู/ุนฺฉุณ ุจูุฑุณุชุฏ ุชุง ุณุฑุน ุจุฑุฑุณ ฺฉูู.", rkb([[["text"=>"โฌ๏ธ ุจุงุฒฺฏุดุช"]]]));
    tg_answerCb($cb["id"]); return;
  }
  
  if (strpos($data, "view_course:") === 0) {
      $course_id = (int)substr($data, strlen("view_course:"));
      $course = get_course_by_id($db, $course_id);
      if (!$course) return;
      
      $price = number_format($course['price']);
      $msg = "<b>{$course['title']}</b>\n\n"
           . "{$course['description']}\n\n"
           . "<b>ููุช:</b> {$price} ุชููุงู";
      tg_sendMessage($chat, $msg, kb([[btn("๐ณ ุฎุฑุฏ ุงู ุฏูุฑู", "buy_course:{$course['id']}")], [btn("โฌ๏ธ ุจุงุฒฺฏุดุช ุจู ูุณุช ุฏูุฑูโูุง", "paid_courses")]]));
      tg_answerCb($cb["id"]);
      return;
  }

  if (strpos($data, "buy_course:") === 0) {
      $course_id = (int)substr($data, strlen("buy_course:"));
      $course = get_course_by_id($db, $course_id);
      if (!$course) return;
      
      $card_file_id = $db["vip_card"]["file_id"] ?? null;
      $price = number_format($course['price']);
      $msg = "ุจุฑุง ุฎุฑุฏ ุฏูุฑู ยซ{$course['title']}ยปุ ูุทูุงู ูุจูุบ <b>{$price} ุชููุงู</b> ุฑุง ุจู ุดูุงุฑู ฺฉุงุฑุช ููุฌูุฏ ุฏุฑ ุชุตูุฑ ุฒุฑ ูุงุฑุฒ ฺฉุฑุฏู ู ุณูพุณ ุงุฒ ุฏฺฉูู ยซุงุฑุณุงู ุฑุณุฏยป ุงุณุชูุงุฏู ฺฉูุฏ.";
      if ($card_file_id) {
          tg_sendPhoto($chat, $card_file_id, $msg, kb([[btn("๐ ุงุฑุณุงู ุนฺฉุณ ุฑุณุฏ", "send_receipt:{$course['id']}")], [btn("โฌ๏ธ ุจุงุฒฺฏุดุช", "paid_courses")]]));
      } else {
          $msg .= "\n\nโน๏ธ <i>ุดูุงุฑู ฺฉุงุฑุช ุชูุณุท ุงุฏูู ุชูุธู ูุดุฏู ุงุณุช. ูุทูุงู ุจู ูพุดุชุจุงู ูพุงู ุฏูุฏ.</i>";
          tg_sendMessage($chat, $msg, kb([[btn("โฌ๏ธ ุจุงุฒฺฏุดุช", "paid_courses")]]));
      }
      tg_answerCb($cb["id"]);
      return;
  }
  
  if (strpos($data, "send_receipt:") === 0) {
      $course_id = (int)substr($data, strlen("send_receipt:"));
      $userForRegAndRestrict["state"] = "await_receipt_{$course_id}";
      db_save($db);
      tg_sendMessage($chat, "๐ธ ูุทูุงู <b>ููุท ุนฺฉุณ ุฑุณุฏ ูพุฑุฏุงุฎุช ุฎูุฏ ุฑุง</b> ุงูุฌุง ุจูุฑุณุชุฏ.", kb([[btn("โฌ๏ธ ุงูุตุฑุงู", "paid_courses")]]));
      tg_answerCb($cb["id"]);
      return;
  }

  if (strpos($data, "start_paid_course:") === 0) {
      $course_id = (int)substr($data, strlen("start_paid_course:"));
      $progress = get_user_course_progress($db, $chat, $course_id);
      if ($progress['status'] !== 'active') {
          tg_answerCb($cb["id"], "ุดูุง ูููุฒ ุจู ุงู ุฏูุฑู ุฏุณุชุฑุณ ูุฏุงุฑุฏ.");
          return;
      }
      $next_step = ($progress['progress'] ?? -1) + 1;
      send_course_step($db, $chat, $course_id, $next_step);
      tg_answerCb($cb["id"]);
      return;
  }


  tg_answerCb($cb["id"]); return;
}
/* ==== CB_HANDLER END =========================================== */